<!doctype html>
<html lang="fr-ca" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-cours/r09" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">R09 - WMI | 420-B64-EM - Scriptage sous Windows </title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://info.cegepmontpetit.ca/b64-scriptage-sous-windows/cours/09"><meta data-rh="true" name="docusaurus_locale" content="fr-ca"><meta data-rh="true" name="docsearch:language" content="fr-ca"><meta data-rh="true" name="keywords" content="420-B64-EM - Scriptage sous Windows , Site de référence du cours de scriptage sous Windows (formation continue), informatique, technique, cégep, cegep, édouard-montpetit, edouard-montpetit, édouard montpetit, edouard montpetit"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="R09 - WMI | 420-B64-EM - Scriptage sous Windows "><meta data-rh="true" name="description" content="1. Présentation de WMI"><meta data-rh="true" property="og:description" content="1. Présentation de WMI"><link data-rh="true" rel="icon" href="/b64-scriptage-sous-windows/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://info.cegepmontpetit.ca/b64-scriptage-sous-windows/cours/09"><link data-rh="true" rel="alternate" href="https://info.cegepmontpetit.ca/b64-scriptage-sous-windows/cours/09" hreflang="fr-ca"><link data-rh="true" rel="alternate" href="https://info.cegepmontpetit.ca/b64-scriptage-sous-windows/cours/09" hreflang="x-default"><link rel="stylesheet" href="/b64-scriptage-sous-windows/assets/css/styles.e90ab40b.css">
<link rel="preload" href="/b64-scriptage-sous-windows/assets/js/runtime~main.f9064aba.js" as="script">
<link rel="preload" href="/b64-scriptage-sous-windows/assets/js/main.7fa074a1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Aller au contenu principal"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Aller au contenu principal</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Ouvrir/fermer la barre de navigation" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/b64-scriptage-sous-windows/"><div class="navbar__logo"><img src="/b64-scriptage-sous-windows/img/logo.svg" alt="Logo CEM" class="themedImage_ToTc themedImage--light_HNdA"><img src="/b64-scriptage-sous-windows/img/logo.svg" alt="Logo CEM" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">420-B64-EM - Scriptage sous Windows </b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/b64-scriptage-sous-windows/cours/01">Cours</a><a class="navbar__item navbar__link" href="/b64-scriptage-sous-windows/tutoriels/github-classroom-simple">Tutoriels</a><a class="navbar__item navbar__link" href="/b64-scriptage-sous-windows/tp/tp1">Travaux Pratiques</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Basculer entre le mode sombre et clair (actuellement mode clair)" aria-label="Basculer entre le mode sombre et clair (actuellement mode clair)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Retour au début de la page" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/01">R01 - Accueil</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/02">R02 - Objets et pipeline</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/03">R03 - Dictionnaires et scripts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/04">R04 - Paramètres, fonctions, fichiers et strings</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/05">R05 - Gestion des comptes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/06">R06 - TP1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/07">R07 - Examen intra</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/08">R08 - Registre et streams</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/b64-scriptage-sous-windows/cours/09">R09 - WMI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/10">R10 - PSRemoting et planification de tâches</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/11">R11 - TP2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/12">R12 - Examen final</a></li></ul></nav><button type="button" title="Réduire le menu latéral" aria-label="Réduire le menu latéral" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Fil d&#x27;Ariane"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Page d&#x27;accueil" class="breadcrumbs__link" href="/b64-scriptage-sous-windows/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">R09 - WMI</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">Sur cette page</button></div><div class="theme-doc-markdown markdown"><h1>Rencontre 9 - WMI</h1><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Résumé de la séance</div><div class="admonitionContent_S0QG"><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">👨‍🏫 Déroulement du cours</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">💻 Exercices à compléter</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">📚 Ressources à consulter</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><ol><li>Présentation de WMI</li><li>Le langage WQL</li><li>Interrogation de WMI avec PowerShell</li><li>Outils d&#x27;exploration de WMI</li></ol></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>Faites la partie 1 du <a href="/b64-scriptage-sous-windows/tp/tp2#partie-1-script-de-lancement">TP2</a>.</p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>La présentation PowerPoint est sur le Teams du cours, sous le canal Général &gt; Fichiers &gt; Supports de cours.</p></div></div></div></div></div><p>WMI (Windows Management Instrumentation) est l&#x27;implémentation par Microsoft du standard ouvert WBEM (Web-Based Enterprise Management) permettant la gestion centralisée et unifiée d&#x27;équipements informatiques en entreprise, lui-même dérivé d&#x27;un autre standard ouvert, CIM (Common Information Model). </p><p>WMI a été introduit nativement dans Windows depuis Windows 2000, et est encore activement utilisé aujourd&#x27;hui par des administrateurs de système afin de gérer des parcs informatiques de manière centralisée et automatisée.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="à-quoi-sert-wmi">À quoi sert WMI?<a href="#à-quoi-sert-wmi" class="hash-link" aria-label="Lien direct vers À quoi sert WMI?" title="Lien direct vers À quoi sert WMI?">​</a></h2><p>Grâce à WMI, on peut interroger et contrôler le système d&#x27;exploitation Windows. WMI est en quelque sorte une librairie de classes servant à accéder différentes ressources du système. Ces ressources sont, par exemple, les propriétés de notre ordinateur (modèle, fabricant, numéro de série, etc.), les différents composants matériels, les applications installées, la configuration réseau, etc.</p><p>Bien sûr, PowerShell offre certaines commandes servant à obtenir des informations sur le système. Par exemple, Get-Process, Get-Service, Get-LocalUser, etc. Mais souvent, ces commandes utilisent WMI en arrière-plan. WMI est beaucoup plus grand et vaste que ce que les commandes PowerShell peuvent nous offrir.</p><p>Voici quelques exemples de ce qu&#x27;on peut faire avec WMI dans un script:</p><ul><li>Savoir si le PC est un portable, un ordinateur de table, un serveur tour, un serveur en rack, etc.</li><li>Connaître le modèle du PC, son fabricant, son numéro de série, etc.</li><li>Obtenir la liste de tous les périphériques branchés</li><li>Obtenir le modèle et le numéro de série de la batterie d&#x27;un laptop</li><li>Obtenir la configuration de la table de routage interne de Windows</li><li>Obtenir la liste et la date d&#x27;installation de toutes les mises à jour de Windows installées</li><li>Obtenir la liste des imprimantes configurées</li><li>Obtenir la liste des partages réseau</li><li>Obtenir la liste de toutes les cartes réseau configurées, avec leur adresses MAC et IP</li><li>Et de nombreuses autres choses, dont certaines impossibles à faire avec les consoles et les commandes existantes.</li></ul><p>Et encore là, ce n&#x27;est que la superficie de ce que WMI permet de réaliser. Autrement dit, WMI donne à nos script la possibilité d&#x27;administrer le système sur lequel il est lancé… et même sur des ordinateurs distants!</p><p>Connaître comment utiliser WMI est vraiment essentiel pour tout administrateur Windows.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture-du-service-wmi">Architecture du service WMI<a href="#architecture-du-service-wmi" class="hash-link" aria-label="Lien direct vers Architecture du service WMI" title="Lien direct vers Architecture du service WMI">​</a></h2><p>WMI est structurée en trois principales couches: Les fournisseurs (providers), l&#x27;infrastructure et les consommateurs (consumers).</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/wmi_architecture-46fa123c9dd1de2b730b98529fee19c9.png" width="510" height="361" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="les-objets-gérés-et-les-providers-wmi">Les objets gérés et les providers WMI<a href="#les-objets-gérés-et-les-providers-wmi" class="hash-link" aria-label="Lien direct vers Les objets gérés et les providers WMI" title="Lien direct vers Les objets gérés et les providers WMI">​</a></h3><p>Un objet géré (<em>managed object</em>) est un composant logiciel ou matériel, tel qu&#x27;un disque dur, une carte réseau, un processus, un service, une application, etc. Ces objets sont accédés par un fournisseur (<em>WMI provider</em>) qui, à la manière d&#x27;un driver, rendent accessibles certaines informations et fonctions les concernant, sous forme de classes. Ces classes possèdent des propriétés et des méthodes, et définissent la nature des objets, lesquels peuvent être présents en plusieurs instances.</p><p>Sous Windows, plusieurs fournisseurs WMI de base sont préinstallés. Ainsi, le fournisseur <code>StrRegProv</code> permet d&#x27;interroger la base de registre de Windows à travers WMI, et le fournisseur Win32 permet de manipuler et d&#x27;interroger les propriétés du système d&#x27;exploitation (processus, services, etc.)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="infrastructure-wmi">Infrastructure WMI<a href="#infrastructure-wmi" class="hash-link" aria-label="Lien direct vers Infrastructure WMI" title="Lien direct vers Infrastructure WMI">​</a></h3><p>L&#x27;infrastructure WMI est un composant de Windows servant à rendre accessibles les objets gérés WMI aux consommateurs. À l&#x27;instar d&#x27;un système de base de données, elle comprend un repository (une sorte de base de données) ainsi qu&#x27;un service pour traiter les requêtes.</p><p>Le repository est organisé sous forme de namespaces, de sorte à former une arborescence sous une racine appelée <code>ROOT</code>. Dans ces namespaces se retrouvent les différentes classes offertes par les providers. Certains namespaces sont créés automatiquement par le service WMI, mais la plupart sont créés par les différents providers enregistrés dans le système.</p><p>À la manière d&#x27;une base de données, on peut interroger le repository en envoyant des requêtes à un service chargé de les traiter. Ce service se nomme winmgmt et fait partie des services de base de Windows. De plus, le service WMI peut être accédé à distance à travers le réseau (à condition que le consommateur dispose de droits d&#x27;administration sur la machine distante et que le pare-feu soit correctement configuré).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="consommateurs-wmi">Consommateurs WMI<a href="#consommateurs-wmi" class="hash-link" aria-label="Lien direct vers Consommateurs WMI" title="Lien direct vers Consommateurs WMI">​</a></h3><p>Le consommateur WMI est toute application ou script qui souhaite interroger la base WMI. Il peut énumérer les <em>namespaces</em>, les classes et leurs instances (objets), interroger leurs propriétés et exécuter leurs méthodes. Les scripts d&#x27;administration sous Windows sont très fréquemment des consommateurs WMI, puisque c&#x27;est souvent l&#x27;unique manière d&#x27;interagir avec certaines propriétés du système d&#x27;exploitation.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="le-wmi-repository">Le <em>WMI Repository</em><a href="#le-wmi-repository" class="hash-link" aria-label="Lien direct vers le-wmi-repository" title="Lien direct vers le-wmi-repository">​</a></h3><p>Essentiellement, la base WMI est composée d&#x27;espaces de nommage, ou <em>namespaces</em>, disposés en arborescence sous la racine <code>ROOT</code>. Le <em>namespace</em> le plus couramment utilisé dans les scripts d&#x27;administration est <code>ROOT\cimv2</code>, et il est généralement considéré comme le <em>namespace</em> par défaut.</p><p>Dans ce <em>namespace</em> se trouvent les classes qui permettent d&#x27;obtenir des informations spécifiques à Windows. Ces classes ont un nom qui débute par le préfixe Win32. Il existe d&#x27;autres classes dans ce <em>namespace</em>, dont plusieurs commencent par le préfixe CIM, mais elle ne sont pas intéressantes puisque plus limitées. Elle sont seulement là pour respecter le standard CIM duquel WMI est inspiré.</p><p>Les ressources du système sont des instances de ces classes, ou objets, qui possèdent des propriétés et des méthodes. Cette structure est directement inspirée par le paradigme orienté-objet.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/wmi_structure-c253e33debaaa361122c814fb458c262.png" width="760" height="390" class="img_ev3q"></p><p>L&#x27;illustration ci-dessous montre l&#x27;outil <a href="https://github.com/vinaypamnani/wmie2/releases" target="_blank" rel="noopener noreferrer">WMI Explorer</a>, permettant de naviguer au sein du repository WMI. Vous y voyez, de gauche à droite, les namespaces, les classes présentes dans le namespace sélectionné, les instances de cette classe, ainsi que les propriétés de l&#x27;instance. Dans cet exemple, la classe <code>Win32_LocalDisk</code> définit ce qu&#x27;est un disque logique, et chaque instance de cette classe représente un disque logique reconnu par Windows. Chaque disque logique possède des propriétés uniques, comme une lettre, une taille, un système de fichiers, etc. </p><p>Cette application interroge le service WMI de la même manière que vous pourriez le faire dans vos scripts. De ce fait, WMI un outil très puissant lorsqu&#x27;il est question de développer des scripts administratifs.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/wmi_explorer-21470452ed6f3e41e7fb6429623260be.png" width="942" height="731" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="le-langage-wql">Le langage WQL<a href="#le-langage-wql" class="hash-link" aria-label="Lien direct vers Le langage WQL" title="Lien direct vers Le langage WQL">​</a></h3><p>Le langage WQL (WMI Query Language) est un dérivé du SQL et sert à effectuer des requêtes au service WMI.</p><p>Pour effectuer une requête simple, on utilise la clause <code>SELECT</code> pour spécifier le nom des propriétés à inclure à la requête et la clause <code>FROM</code> pour spécifier la classe WMI.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> Name</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> FileSystem</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> Size</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> FreeSpace </span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> Win32_LogicalDisk</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>On peut voir toutes les propriétés avec <code>SELECT *</code>.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> Win32_LogicalDisk</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>On peut ajouter un filtre à l&#x27;aide de la clause <code>WHERE</code> avec une condition (<em>propriété opérateur constante</em>).</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> Win32_LogicalDisk </span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> FileSystem </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;NTFS&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Les opérateurs admissibles sont:</p><table><thead><tr><th>Opérateur</th><th>Description</th></tr></thead><tbody><tr><td><strong>=</strong></td><td>Égal à</td></tr><tr><td><strong>&lt;</strong></td><td>Plus petit que</td></tr><tr><td><strong>&gt;</strong></td><td>Plus grand que</td></tr><tr><td><strong>&lt;=</strong></td><td>Plus petit ou égal à</td></tr><tr><td><strong>&gt;<!-- -->=</strong></td><td>Plus grand ou égal à</td></tr><tr><td><strong>!=</strong> ou <strong>&lt;<!-- -->&gt;</strong></td><td>Différent de</td></tr><tr><td><strong>IS NULL</strong></td><td>Est nul</td></tr><tr><td><strong>IS NOT NULL</strong></td><td>N&#x27;est pas nul</td></tr><tr><td><strong>AND</strong></td><td>Et logique (pour spécifier plusieurs conditions)</td></tr><tr><td><strong>OR</strong></td><td>Ou logique (pour spécifier plusieurs conditions)</td></tr><tr><td><strong>NOT</strong></td><td>Non logique</td></tr><tr><td><strong>LIKE</strong></td><td>Comparaison de chaîne de caractère avec <em>wildcard</em></td></tr></tbody></table><p>Les wildcards admissibles avec l&#x27;opérateur <code>LIKE</code> sont:</p><table><thead><tr><th><em>Wildcard</em></th><th>Description</th></tr></thead><tbody><tr><td><strong>%</strong></td><td>N&#x27;importe quelle chaîne de 0 ou plus caractères</td></tr><tr><td><strong>_</strong></td><td>N&#x27;importe quel caractère (un seul)</td></tr><tr><td><strong>[ ]</strong></td><td>Un caractère parmi les caractères en crochet (<code>[a-f]</code> ou <code>[abcdef]</code>)</td></tr><tr><td><strong>[^ ]</strong></td><td>Un caractère autre que ceux spécifiés en crochet (<code>[^a-f]</code> ou <code>[^abcdef]</code>)</td></tr></tbody></table><p>Voici un exemple de requête permettant d&#x27;obtenir toutes les imprimantes locales de marque HP.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">Select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> Win32_Printer </span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">Local</span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token string" style="color:rgb(163, 21, 21)">&quot;TRUE&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">AND</span><span class="token plain"> DriverName </span><span class="token operator" style="color:rgb(0, 0, 0)">LIKE</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;%HP%&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="utilisation-de-wmi-avec-powershell">Utilisation de WMI avec PowerShell<a href="#utilisation-de-wmi-avec-powershell" class="hash-link" aria-label="Lien direct vers Utilisation de WMI avec PowerShell" title="Lien direct vers Utilisation de WMI avec PowerShell">​</a></h2><p>Il existe plusieurs manières d&#x27;interroger le service WMI, mais la plus simple en PowerShell consiste à utiliser la commande <code>Get-WmiObject</code>, ou son alias <code>gwmi</code>.</p><p>La principale utilisation de la commande <code>Get-WmiObject</code> vise à obtenir une ou plusieurs instances d&#x27;une classe dans un <em>namespace</em> donné. Il en résulte à sa sortie un tableau d&#x27;objets qui possèdent les propriétés et les méthodes définis par leur classe.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi01-9d863df4780837d1f7981c0e7490db4d.png" width="869" height="201" class="img_ev3q"></p><p>Cette commande se comporte comme la plupart des commandes PowerShell, en ce sens qu&#x27;elle retourne un objet. Cet objet peut être manipulé à l&#x27;instar de tous les objets PowerShell.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi02-ebcb45a5f75ffac7d438b0ef338bcc9d.png" width="869" height="141" class="img_ev3q"></p><p>Le paramètre <code>-Namespace</code> est optionnel. Lorsqu&#x27;il est omis, la commande regarde dans <code>ROOT\cimv2</code>. Et on peut spécifier la classe sans devoir spécifier le nom du paramètre <code>-Class</code>. </p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi03-86b9d6e14fe2255b786672d188af0999.png" width="869" height="199" class="img_ev3q"></p><p>Les objets correspondant à une instance de classe WMI sont de type ManagementObject.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi04-b508cb1aac420f72da8231b2b011988d.png" width="869" height="168" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="commande-get-wmiobject">Commande <em>Get-WmiObject</em><a href="#commande-get-wmiobject" class="hash-link" aria-label="Lien direct vers commande-get-wmiobject" title="Lien direct vers commande-get-wmiobject">​</a></h2><p>Voici les principaux paramètres qu&#x27;on peut fournir à <code>Get-WmiObject</code>:</p><table><thead><tr><th>Paramètre</th><th>Description</th></tr></thead><tbody><tr><td><code>-Class</code></td><td>Nom de la classe WMI dont on veut obtenir les instances.</td></tr><tr><td><code>-Property</code></td><td>Propriété(s) à récupérer (pour s&#x27;éviter un <code>Select-Object</code>)</td></tr><tr><td><code>-Namespace</code></td><td>Le <em>namespace</em> où se trouve la classe. Si ce paramètre n&#x27;est pas spécifié, c&#x27;est <code>ROOT\cimv2</code> qui est pris par défaut</td></tr><tr><td><code>-Filter</code></td><td>Spécifie un filtre pour ne retourner que certains objets selon les critères spécifiés. Attention, ce paramètre n&#x27;a pas la syntaxe PowerShell mais WQL (proche du SQL).</td></tr><tr><td><code>-Query</code></td><td>Au lieu des paramètres <code>-Class</code>, <code>-Property</code> et <code>-Filter</code>, on peut définir une chaîne de caractère représentant une requête WQL (par exemple, <code>SELECT * FROM Win32_LogicalDisk WHERE FileSystem = &#x27;NTFS&#x27;</code>)</td></tr><tr><td><code>-ComputerName</code></td><td>Nom de l&#x27;ordinateur sur lequel on veut effectuer la requête. Si ce paramètre n&#x27;est pas spécifié, c&#x27;est &quot;<code>.</code>&quot; qui est sa valeur par défaut, ce qui correspond à la machine locale.</td></tr><tr><td><code>-Credential</code></td><td>Objet de type <code>[PSCredential]</code> pour l&#x27;authentification. Cette notion sera couverte plus tard.</td></tr><tr><td><code>-List</code></td><td>Affiche la liste des classes du <em>namespace</em> (soit celui spécifié dans le paramètre <code>-Namespace</code>, soit <code>ROOT\cimv2</code> par défaut)</td></tr></tbody></table><p>En sortie, <code>Get-WmiObject</code> envoie dans le pipeline un tableau d&#x27;objets de type <code>[ManagementObject]</code>, ou un objet unique lorsqu&#x27;il n&#x27;y a qu&#x27;une instance. Cet objet peut être affecté à une variable, ou passé à une autre commande via le pipeline, comme les commandes <code>Format-</code>, <code>Out-</code>, <code>Sort-</code>, <code>Select-</code>, etc. Autrement, cet objet tombe dans l&#x27;hôte et est converti en texte.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi05-601c95746cae1bb5f9d4c4fa4c4d1d89.png" width="869" height="316" class="img_ev3q"></p><p>On voit cependant que cette commande retourne aussi certaines propriétés système propres à WMI, alors il peut être intéressant de passer cet objet dans un <code>Select-Object</code> pour sélectionner les propriétés qu&#x27;on veut.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi06-5148068ca86d2049ee6ccc3c13ac2f1d.png" width="869" height="258" class="img_ev3q"></p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>astuce</div><div class="admonitionContent_S0QG"><p>Le paramètre <code>-Property</code> de <code>Get-WmiObject</code> peut quand même être pratique en conjonction avec <code>Select-Object</code>, car certains objets WMI ont un grand nombre de propriétés. WMI est un système particulièrement lent, alors si vous ne spécifiez pas les propriétés dans <code>Get-WmiObject</code>, ça pourrait nuire à la performance de votre script.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="énumération-des-classes-wmi">Énumération des classes WMI<a href="#énumération-des-classes-wmi" class="hash-link" aria-label="Lien direct vers Énumération des classes WMI" title="Lien direct vers Énumération des classes WMI">​</a></h2><p>On peut obtenir la liste des classes avec <code>Get-WMIObject -List</code>. Par défaut, on recherche dans le namespace <code>cimv2</code>.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi07-dd3004a126da7cdfbefcec367775d914.png" width="989" height="275" class="img_ev3q"></p><p>Pour une recherche plus précise, on peut spécifier un <strong>filtre</strong>.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi08-648677b10a9b954cec0f785de668b4b2.png" width="989" height="307" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="quelques-classes-intéressantes">Quelques classes intéressantes<a href="#quelques-classes-intéressantes" class="hash-link" aria-label="Lien direct vers Quelques classes intéressantes" title="Lien direct vers Quelques classes intéressantes">​</a></h3><p>Voici quelques classes particulièrement utiles sous <code>ROOT\cimv2</code>:</p><table><thead><tr><th>Classe</th><th>Description</th></tr></thead><tbody><tr><td><code>Win32_ComputerSystem</code></td><td>Informations de base sur le système, comme le modèle et le fabricant, le hostname, le domaine AD, le fuseau horaire, le nombre de processeurs logiques, etc.</td></tr><tr><td><code>Win32_NetworkAdapter</code></td><td>Cartes réseau (physiques et logiques) installées.</td></tr><tr><td><code>Win32_NetworkAdapterConnection</code></td><td>Configuration des cartes réseau (puisqu&#x27;une carte réseau peut avoir plusieurs connections, il doit y avoir une classe différente)</td></tr><tr><td><code>Win32_NetworkConnection</code></td><td>Partages réseau mappés.</td></tr><tr><td><code>Win32_LogicalDisk</code></td><td>Les disques durs logiques (C:, D:, etc.)</td></tr><tr><td><code>Win32_Account</code></td><td>Comptes utilisateurs et des groupes locaux.</td></tr><tr><td><code>Win32_UserAccount</code></td><td>Comptes utilisateurs locaux</td></tr><tr><td><code>Win32_Group</code></td><td>Groupes locaux</td></tr><tr><td><code>Win32_NTLogEvent</code></td><td>Événements du journal d&#x27;événements Windows</td></tr><tr><td><code>Win32_Process</code></td><td>Processus en exécution</td></tr><tr><td><code>Win32_Service</code></td><td>Services</td></tr><tr><td><code>Win32_SystemEnclosure</code></td><td>Information sur le boîtier et le facteur de forme (par exemple, pour distinguer les laptops, les tours, les serveurs rackmount, les tablettes, etc.)</td></tr><tr><td><code>Win32_BIOS</code></td><td>Information sur le BIOS (fabricant, version, révision, etc.)</td></tr><tr><td><code>Win32_Battery</code></td><td>Information sur la batterie (charge restante...)</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="collectins-dobjets-et-filtrage">Collectins d&#x27;objets et filtrage<a href="#collectins-dobjets-et-filtrage" class="hash-link" aria-label="Lien direct vers Collectins d&#x27;objets et filtrage" title="Lien direct vers Collectins d&#x27;objets et filtrage">​</a></h2><p>Certaines classes n&#x27;ont qu&#x27;une seule instance (par exemple, <code>Win32_ComputerSystem</code>), mais d&#x27;autres en ont plusieurs. Lorsqu&#x27;on exécute une requête WMI sur ces classes, on obtient un tableau d&#x27;objets.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi09-6feb9ffe56c5b165ac3d76180b51954d.png" width="869" height="326" class="img_ev3q"></p><p>Il se trouve que par défaut, <code>Get-WmiObject</code> est formatée en liste plutôt qu&#x27;en tableau. Mais il s&#x27;agit bel et bien d&#x27;un objet et on peut le manipuler de la même manière que toutes les autres collections PowerShell.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi10-7978c3474d188e1585d6fa0e34ae21bb.png" width="869" height="303" class="img_ev3q"></p><p>Si on veut une instance spécifique, on doit définir un filtre. Il y a plusieurs manières de procéder.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="avec-where-object">Avec <em>Where-Object</em><a href="#avec-where-object" class="hash-link" aria-label="Lien direct vers avec-where-object" title="Lien direct vers avec-where-object">​</a></h3><p>On peut utiliser l&#x27;habituelle commande <code>Where-Object</code> pour filtrer une collection et ne garder qu&#x27;une ou certaines de ses instances.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi11-ab542dcc2dd20bb9c6e0274982516ec7.png" width="859" height="189" class="img_ev3q"></p><p>Ou on peut aussi utiliser cette méthode pour obtenir une collection plus petite de toutes les instances qui obéissent à une condition précise. </p><p>Dans cet exemple, on filtre pour ne retenir que les disques locaux et non les disques réseau. Selon la documentation, la propriété <code>DriveType</code> prend la valeur 3 pour un disque local et 4 pour un lecteur réseau. </p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi12-506d843e201d83bc71f1d0c074040cd2.png" width="869" height="157" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dans-la-requête-wmi">Dans la requête WMI<a href="#dans-la-requête-wmi" class="hash-link" aria-label="Lien direct vers Dans la requête WMI" title="Lien direct vers Dans la requête WMI">​</a></h3><p>On peut utiliser le paramètre <code>-Filter</code> de <code>Get-WmiObject</code> pour définir les critères.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi13-d6a1139a9f153131ef73dd9d6e30c331.png" width="869" height="211" class="img_ev3q"></p><p>Cette technique préférable à <code>Where-Object</code> dans la plupart des cas, car avec cette dernière, toutes les instances circulent dans le pipeline avant le <code>Where-Object</code>. </p><p>Supposons que le résultat de la requête <code>Get-WmiObject</code> donnait un million d&#x27;instances. Avec <code>Where-Object</code>, il aurait fallu accumuler un million d&#x27;objets dans le pipeline, avant le filtrage. Lorsqu&#x27;on spécifie le filtre dans la requête WMI, on évite de manipuler les objets qu&#x27;on ne veut pas. Ainsi, on gagne en performance et on évite de surutiliser la mémoire du système.</p><p>Le désavantage de cette méthode, c&#x27;est que les critères doivent être définis en WQL et non en PowerShell. WQL est un langage plus limité que PowerShell. Il arrive parfois qu&#x27;on doive faire une partie du travail de filtrage par la requête WMI, puis une autre passe, plus fine, avec <code>Where-Object</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dans-une-requête-wql">Dans une requête WQL<a href="#dans-une-requête-wql" class="hash-link" aria-label="Lien direct vers Dans une requête WQL" title="Lien direct vers Dans une requête WQL">​</a></h3><p>Lorsqu&#x27;on choisit d&#x27;utiliser une requête WQL, le filtre doit être défini après la clause <code>WHERE</code>, de la même manière qu&#x27;en SQL.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi14-2af10bd658279afa9ac7e98fc8dc92d7.png" width="869" height="224" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="membres-des-objets">Membres des objets<a href="#membres-des-objets" class="hash-link" aria-label="Lien direct vers Membres des objets" title="Lien direct vers Membres des objets">​</a></h2><p>La commande <code>Get-WmiObject</code> s&#x27;utilise de la même manière que <code>Get-Process</code>, <code>Get-Service</code> ou <code>Get-ChildItem</code>. Il sort de cette commande un objet (lorsque WMI ne possède qu&#x27;une seule instance de cette classe) ou un tableau d&#x27;objets (lorsque WMI possède plusieurs instances). Ces objets ont des membres (des propriétés et des méthodes) correspondant à celles de leur classe. Les techniques pour explorer ces objets à la recherche de ce qu&#x27;on peut exploiter sont donc semblables à ce qu&#x27;on peut faire avec les objets retournés par les commandes natives de PowerShell.</p><p>La classe <code>Win32_OperatingSystem</code> définit plusieurs propriétés d&#x27;un système d&#x27;exploitation Windows. Comme il n&#x27;y a qu&#x27;un seul système d&#x27;exploitation actif dans un système, il n&#x27;y a qu&#x27;un objet, et non une instance d&#x27;objets, qui sort de la commande. Avec un <code>Select-Object *</code> ou un <code>Format-List *</code>, on peut forcer PowerShell à afficher toutes les propriétés de l&#x27;objet.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi15-4ebe5f7c4527fbe894f6a69249c632a6.png" width="869" height="460" class="img_ev3q"></p><p>S&#x27;il y a plusieurs instances de la classe recherchée, il faut être un peu plus créatif. On pourrait sélectionner un seul objet pour observer son contenu:</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi16-6befea1ba421d92cc264ecf8e6552c95.png" width="869" height="207" class="img_ev3q"></p><p>Ou encore utiliser <code>Out-GridView</code>…</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi17-14d014aea13d973042ecff24f39e8ea2.png" width="869" height="255" class="img_ev3q"></p><p>Ou bien exporter en CSV pour pouvoir importer directement dans Excel!</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi18-406300190e1370639dfeecb95db0f695.png" width="850" height="448" class="img_ev3q"></p><p>Une autre approche consiste à utiliser <code>Get-Member</code>. On peut voir les propriétés, mais aussi les méthodes pouvant être appelées sur cet objet. On peut aussi connaître le type de données de ces propriétés. Cependant, cela ne nous permet pas de voir le contenu.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi19-0c74250f67bc30d2af718dfb9d613d38.png" width="869" height="292" class="img_ev3q"></p><p>On peut aussi utiliser le paramètre <code>-MemberType</code> de <code>Get-Member</code> pour n&#x27;afficher que les propriétés ou les méthodes.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi20-4a41551b1134041ec4696d889a821d12.png" width="869" height="195" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="propriétés">Propriétés<a href="#propriétés" class="hash-link" aria-label="Lien direct vers Propriétés" title="Lien direct vers Propriétés">​</a></h3><p>On interroge les propriétés d&#x27;un objet WMI de la même manière que sur un objet ordinaire. On peut manipuler les propriétés à notre guise et faire toutes les manipulations qu&#x27;on souhaite.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi21-a4c2511ae4202101bd0e957ded72c379.png" width="988" height="645" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="méthodes">Méthodes<a href="#méthodes" class="hash-link" aria-label="Lien direct vers Méthodes" title="Lien direct vers Méthodes">​</a></h3><p>Il y a plus d&#x27;une manière d&#x27;appeler une méthode sur un objet WMI.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="option-1-par-un-appel-de-méthode-sur-lobjet">Option 1: Par un appel de méthode sur l&#x27;objet<a href="#option-1-par-un-appel-de-méthode-sur-lobjet" class="hash-link" aria-label="Lien direct vers Option 1: Par un appel de méthode sur l&#x27;objet" title="Lien direct vers Option 1: Par un appel de méthode sur l&#x27;objet">​</a></h4><p>Cette technique revient à simplement appeler une méthode comme vous êtes habitués de le faire. L&#x27;exemple ici se fait avec une variable pour, mais on pourrait très bien le faire sur la même ligne.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi22-d2dcd0ae16e25833539651b994543929.png" width="871" height="300" class="img_ev3q"></p><p>Notez ci-dessus qu&#x27;un objet est retourné. Cet objet sert transmettre au consommateur de WMI un code de retour, où 0 signifie un succès, et n&#x27;importe quelle autre valeur signifie qu&#x27;une erreur est survenue.</p><p>Lorsqu&#x27;il y a plusieurs processus du même nom (ici, deux processus <em>notepad.exe</em>), alors la méthode est exécutée à chacun des objets, sans qu&#x27;on n&#x27;ait besoin de faire une boucle.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi23-09ce9fca15c7736db6f747bbcd863f2e.png" width="869" height="456" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="option-2-avec-la-commande-invoke-wmimethod">Option 2: Avec la commande <em>Invoke-WmiMethod</em><a href="#option-2-avec-la-commande-invoke-wmimethod" class="hash-link" aria-label="Lien direct vers option-2-avec-la-commande-invoke-wmimethod" title="Lien direct vers option-2-avec-la-commande-invoke-wmimethod">​</a></h4><p>On peut aussi utiliser la commande <code>Invoke-WmiMethod</code>. Il suffit de lui passer un objet WMI dans le pipeline et spécifier le nom de la méthode.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi24-fe4ce13c469d62ec895b417121bc6be2.png" width="869" height="284" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="passage-de-paramètres">Passage de paramètres<a href="#passage-de-paramètres" class="hash-link" aria-label="Lien direct vers Passage de paramètres" title="Lien direct vers Passage de paramètres">​</a></h4><p>On peut passer des paramètres aux méthodes WMI. Cependant, il faut souvent se fier à la documentation de Microsoft pour connaître quels paramètres passer et dans quel format.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi25-dd50654768ae8542477836757cbbeadb.png" width="869" height="536" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cacher-lobjet-de-retour">Cacher l&#x27;objet de retour<a href="#cacher-lobjet-de-retour" class="hash-link" aria-label="Lien direct vers Cacher l&#x27;objet de retour" title="Lien direct vers Cacher l&#x27;objet de retour">​</a></h4><p>Si, dans votre script, vous souhaitez invoquer une méthode d&#x27;un objet WMI, vous ne voulez pas vraiment que le script affiche l&#x27;objet de retour.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi26-5425472054116d5148e97331c7982c72.png" width="1007" height="645" class="img_ev3q"></p><p>Une manière de faire est d&#x27;affecter cet objet dans une variable. Ainsi, il ne tomberait pas dans la console à la fin du pipeline. Cependant, ce n&#x27;est pas propre puisqu&#x27;on utilise de la mémoire inutilement (à moins, bien sûr, qu&#x27;on souhaite utiliser cet objet par la suite).</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi27-084c668ca0310f23a82eece0d99e2ff5.png" width="1007" height="197" class="img_ev3q"></p><p>On pourrait aussi affecter cet objet dans une variable, mais cette fois, dans la variable $null. Cette variable est spéciale car elle est toujours vide. Donc si on affecte l&#x27;objet dans cette variable, il n&#x27;aboutit pas dans la console et sa référence est instantanément détruite.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi28-78111d56e6022ed628ef467987c3e2c1.png" width="1007" height="196" class="img_ev3q"></p><p>Il y a une manière plus propre et beaucoup plus explicite d&#x27;envoyer un objet dans le néant. Il suffit de terminer le pipeline avec la commande de sortie Out-Null.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/gwmi29-846567da6d1e733192010797663dc6e4.png" width="1007" height="357" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="outils">Outils<a href="#outils" class="hash-link" aria-label="Lien direct vers Outils" title="Lien direct vers Outils">​</a></h2><p>Plusieurs outils permettent d&#x27;explorer WMI de manière conviviale. Cela peut vous aider grandement dans vos scripts!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="wbemtest">WBEMTest<a href="#wbemtest" class="hash-link" aria-label="Lien direct vers WBEMTest" title="Lien direct vers WBEMTest">​</a></h3><p>C&#x27;est un outil inclus dans Windows. Il permet d&#x27;explorer WMI, mais il est difficile à utiliser et peu convivial. WMI est beaucoup plus vaste et complexe que ce qui est couvert dans ce cours, et cet outil permet d&#x27;explorer la mécanique interne de WMI. Par contre, l&#x27;outil est inclus dans Windows (tapez simplement &quot;wbemtest&quot; dans une ligne de commande pour le lancer), ce qui vous évite de devoir télécharger un outil.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/outil_wbemtest-50b90a11875e77939aa83248cf010771.png" width="1090" height="671" class="img_ev3q"></p><p>Voici l&#x27;article de la documentation portant sur cet outil:
<a href="https://docs.microsoft.com/en-us/mem/configmgr/develop/core/understand/introduction-to-wbemtest" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/en-us/mem/configmgr/develop/core/understand/introduction-to-wbemtest</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="wmiexplorer-20">WMIExplorer 2.0<a href="#wmiexplorer-20" class="hash-link" aria-label="Lien direct vers WMIExplorer 2.0" title="Lien direct vers WMIExplorer 2.0">​</a></h3><p>Cet outil est le meilleur que je connaisse, et il est gratuit. Il peut se connecter sur la machine locale ou une machine distante sur le réseau, et permet de générer des scripts automatiquement! Je vous encourage fortement à l&#x27;essayer.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/outil_wmiexplorer2-c98052bf76e9a9921dce30f6e8684050.png" width="1076" height="638" class="img_ev3q"></p><p>Vous pouvez le télécharger ici:
<a href="https://github.com/vinaypamnani/wmie2/releases/latest" target="_blank" rel="noopener noreferrer">https://github.com/vinaypamnani/wmie2/releases/latest</a> </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="powershell-wmi-browser">PowerShell WMI Browser<a href="#powershell-wmi-browser" class="hash-link" aria-label="Lien direct vers PowerShell WMI Browser" title="Lien direct vers PowerShell WMI Browser">​</a></h3><p>Cet outil est aussi gratuit et téléchargeable sur Internet. Il n&#x27;est pas aussi avancé que WMIExplorer, mais il est programmé complètement en PowerShell! Vous pouvez voir son code.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/outil_wmibrowser-9c256a8275c446c4c3ef578e6d2cbb94.png" width="1196" height="587" class="img_ev3q"></p><p>Oui, on peut faire des interfaces graphiques en PowerShell! :-)</p><p>Vous pouvez le télécharger ici:
<a href="https://jdhitsolutions.com/blog/powershell/2848/wmi-explorer-from-the-powershell-guy/" target="_blank" rel="noopener noreferrer">https://jdhitsolutions.com/blog/powershell/2848/wmi-explorer-from-the-powershell-guy/</a></p><p>Il y en a d&#x27;autres, mais ils sont soit payants ou désuets. Les outils ci-dessus, en plus de la commande <code>Get-WmiObject</code>, vous donneront tout ce qu&#x27;il vous faut pour utiliser WMI!</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="wmi-explorer-20-mon-préféré">WMI Explorer 2.0 (mon préféré)<a href="#wmi-explorer-20-mon-préféré" class="hash-link" aria-label="Lien direct vers WMI Explorer 2.0 (mon préféré)" title="Lien direct vers WMI Explorer 2.0 (mon préféré)">​</a></h2><p>Cet outil est le meilleur que je connaisse, et il est gratuit. Vous pouvez le télécharger sur le site GitHub de son développeur (<a href="https://github.com/vinaypamnani/wmie2/releases/latest" target="_blank" rel="noopener noreferrer">https://github.com/vinaypamnani/wmie2/releases/latest</a>)</p><p>Lorsque vous ouvrez cet outil, vous pouvez parcourir les différents namespaces. Un double-clic sur le namespace énumère ses classes, et un double-clic sur une classe énumère ses instances. Finalement, sélectionnez une instance et vous aurez toutes ses propriétés. Vous pouvez spécifier un ordinateur différent du votre (le &quot;.&quot; réfère à l&#x27;ordinateur local). En prime, vous avez en tout temps au bas de la fenêtre la requête WQL correspondant à l&#x27;instance que vous avez sélectionnée.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/outil_wmie01-78af8774aaccedf11036cda33861cae5.png" width="1076" height="638" class="img_ev3q"></p><p>Dans l&#x27;onglet Properties, vous avez une liste de toutes les propriétés de la classe sélectionnée, tirée de la documentation de WMI.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/outil_wmie02-ddc9325f98e94e97f623fab0847b3338.png" width="801" height="405" class="img_ev3q"></p><p>Et dans l&#x27;onglet Methods, vous avez la même chose mais pour les méthodes, avec la définition des paramètres d&#x27;entrée et de sortie. Attention, ces méthodes ne se comportent pas comme des méthodes classique appelées dans PowerShell, et il peut être un peu ardu de les utiliser.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/outil_wmie03-4672a56576a0b159e806a2f94de45d0f.png" width="801" height="503" class="img_ev3q"></p><p>D&#x27;ailleurs, pour exécuter une méthode, il suffit de cliquer-droit sur l&#x27;instance (pour un méthode non statique) ou sur la classe (pour une méthode statique).</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/outil_wmie04-a9f754a4328a7e39aa08429b70b4c76b.png" width="539" height="286" class="img_ev3q"></p><p>Mais là où cet outil devient vraiment intéressant (et presque de la triche), c&#x27;est dans l&#x27;onglet Script. Vous pouvez générer automatiquement un bout de code PowerShell qui récupère toutes les propriétés des instances de la classe, et le coller dans votre script. Le bout de code tel quel ne sert pas à grand-chose, mais il vous donne un exemple d&#x27;utilisation de toutes les propriétés des objets. Vous n&#x27;avez ensuite à prendre ce que vous voulez. L&#x27;outil ne fait pas tout le travail, mais en fait une partie à votre place. </p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/outil_wmie05-995ecddcf630e3c0b664ebafa79e0801.png" width="810" height="343" class="img_ev3q"></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Dernière mise à jour<!-- --> le <b><time datetime="2023-11-14T21:14:36.000Z">14 nov. 2023</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Pages de documentation"><a class="pagination-nav__link pagination-nav__link--prev" href="/b64-scriptage-sous-windows/cours/08"><div class="pagination-nav__sublabel">Précédent</div><div class="pagination-nav__label">R08 - Registre et streams</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/b64-scriptage-sous-windows/cours/10"><div class="pagination-nav__sublabel">Suivant</div><div class="pagination-nav__label">R10 - PSRemoting et planification de tâches</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#à-quoi-sert-wmi" class="table-of-contents__link toc-highlight">À quoi sert WMI?</a></li><li><a href="#architecture-du-service-wmi" class="table-of-contents__link toc-highlight">Architecture du service WMI</a><ul><li><a href="#les-objets-gérés-et-les-providers-wmi" class="table-of-contents__link toc-highlight">Les objets gérés et les providers WMI</a></li><li><a href="#infrastructure-wmi" class="table-of-contents__link toc-highlight">Infrastructure WMI</a></li><li><a href="#consommateurs-wmi" class="table-of-contents__link toc-highlight">Consommateurs WMI</a></li><li><a href="#le-wmi-repository" class="table-of-contents__link toc-highlight">Le <em>WMI Repository</em></a></li><li><a href="#le-langage-wql" class="table-of-contents__link toc-highlight">Le langage WQL</a></li></ul></li><li><a href="#utilisation-de-wmi-avec-powershell" class="table-of-contents__link toc-highlight">Utilisation de WMI avec PowerShell</a></li><li><a href="#commande-get-wmiobject" class="table-of-contents__link toc-highlight">Commande <em>Get-WmiObject</em></a></li><li><a href="#énumération-des-classes-wmi" class="table-of-contents__link toc-highlight">Énumération des classes WMI</a><ul><li><a href="#quelques-classes-intéressantes" class="table-of-contents__link toc-highlight">Quelques classes intéressantes</a></li></ul></li><li><a href="#collectins-dobjets-et-filtrage" class="table-of-contents__link toc-highlight">Collectins d&#39;objets et filtrage</a><ul><li><a href="#avec-where-object" class="table-of-contents__link toc-highlight">Avec <em>Where-Object</em></a></li><li><a href="#dans-la-requête-wmi" class="table-of-contents__link toc-highlight">Dans la requête WMI</a></li><li><a href="#dans-une-requête-wql" class="table-of-contents__link toc-highlight">Dans une requête WQL</a></li></ul></li><li><a href="#membres-des-objets" class="table-of-contents__link toc-highlight">Membres des objets</a><ul><li><a href="#propriétés" class="table-of-contents__link toc-highlight">Propriétés</a></li><li><a href="#méthodes" class="table-of-contents__link toc-highlight">Méthodes</a></li></ul></li><li><a href="#outils" class="table-of-contents__link toc-highlight">Outils</a><ul><li><a href="#wbemtest" class="table-of-contents__link toc-highlight">WBEMTest</a></li><li><a href="#wmiexplorer-20" class="table-of-contents__link toc-highlight">WMIExplorer 2.0</a></li><li><a href="#powershell-wmi-browser" class="table-of-contents__link toc-highlight">PowerShell WMI Browser</a></li></ul></li><li><a href="#wmi-explorer-20-mon-préféré" class="table-of-contents__link toc-highlight">WMI Explorer 2.0 (mon préféré)</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Sources</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/departement-info-cem/b64-scriptage-sous-windows" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Vincent Carrier. Tous droits réservés.</div></div></div></footer></div>
<script src="/b64-scriptage-sous-windows/assets/js/runtime~main.f9064aba.js"></script>
<script src="/b64-scriptage-sous-windows/assets/js/main.7fa074a1.js"></script>
</body>
</html>