<!doctype html>
<html lang="fr-ca" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-cours/r10" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">R10 - WinRM et planification | 420-B64-EM - Scriptage sous Windows </title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://info.cegepmontpetit.ca/b64-scriptage-sous-windows/cours/10"><meta data-rh="true" name="docusaurus_locale" content="fr-ca"><meta data-rh="true" name="docsearch:language" content="fr-ca"><meta data-rh="true" name="keywords" content="420-B64-EM - Scriptage sous Windows , Site de référence du cours de scriptage sous Windows (formation continue), informatique, technique, cégep, cegep, édouard-montpetit, edouard-montpetit, édouard montpetit, edouard montpetit"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="R10 - WinRM et planification | 420-B64-EM - Scriptage sous Windows "><meta data-rh="true" name="description" content="- Protocoles de communication pour l&#x27;administration à distance"><meta data-rh="true" property="og:description" content="- Protocoles de communication pour l&#x27;administration à distance"><link data-rh="true" rel="icon" href="/b64-scriptage-sous-windows/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://info.cegepmontpetit.ca/b64-scriptage-sous-windows/cours/10"><link data-rh="true" rel="alternate" href="https://info.cegepmontpetit.ca/b64-scriptage-sous-windows/cours/10" hreflang="fr-ca"><link data-rh="true" rel="alternate" href="https://info.cegepmontpetit.ca/b64-scriptage-sous-windows/cours/10" hreflang="x-default"><link rel="stylesheet" href="/b64-scriptage-sous-windows/assets/css/styles.e90ab40b.css">
<link rel="preload" href="/b64-scriptage-sous-windows/assets/js/runtime~main.ade9795c.js" as="script">
<link rel="preload" href="/b64-scriptage-sous-windows/assets/js/main.4c0c98db.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Aller au contenu principal"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Aller au contenu principal</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Ouvrir/fermer la barre de navigation" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/b64-scriptage-sous-windows/"><div class="navbar__logo"><img src="/b64-scriptage-sous-windows/img/logo.svg" alt="Logo CEM" class="themedImage_ToTc themedImage--light_HNdA"><img src="/b64-scriptage-sous-windows/img/logo.svg" alt="Logo CEM" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">420-B64-EM - Scriptage sous Windows </b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/b64-scriptage-sous-windows/cours/01">Cours</a><a class="navbar__item navbar__link" href="/b64-scriptage-sous-windows/tutoriels/github-classroom-simple">Tutoriels</a><a class="navbar__item navbar__link" href="/b64-scriptage-sous-windows/tp/tp1">Travaux Pratiques</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Basculer entre le mode sombre et clair (actuellement mode clair)" aria-label="Basculer entre le mode sombre et clair (actuellement mode clair)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Retour au début de la page" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/01">R01 - Accueil</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/02">R02 - Objets et pipeline</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/03">R03 - Dictionnaires et scripts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/04">R04 - Paramètres, fonctions, fichiers et strings</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/05">R05 - Gestion des comptes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/06">R06 - Travail pratique 1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/07">R07 - Examen intra</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/08">R08 - Registre et streams</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/09">R09 - Requêtes WMI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/b64-scriptage-sous-windows/cours/10">R10 - WinRM et planification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/11">R11 - Travail pratique 2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/b64-scriptage-sous-windows/cours/12">R12 - Examen final</a></li></ul></nav><button type="button" title="Réduire le menu latéral" aria-label="Réduire le menu latéral" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Fil d&#x27;Ariane"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Page d&#x27;accueil" class="breadcrumbs__link" href="/b64-scriptage-sous-windows/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">R10 - WinRM et planification</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">Sur cette page</button></div><div class="theme-doc-markdown markdown"><h1>Rencontre 10 - WinRM et planification</h1><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Résumé de la séance du vendredi 24 novembre 2023</div><div class="admonitionContent_S0QG"><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">👨‍🏫 Déroulement du cours</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">💻 Exercices à compléter</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">📚 Ressources à consulter</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><ul><li>Protocoles de communication pour l&#x27;administration à distance<ul><li>MSRPC / DCOM</li><li>WinRM / WS-Management</li></ul></li><li>Sessions PowerShell à distance (PSRemoting et WinRM)<ul><li>Interactif par la console (Enter-PSSession, Exit-PSSession...)</li><li>Dans un script (New-PSSession, Invoke-Command...)</li></ul></li><li>Planification de tâches<ul><li>Par l&#x27;interface graphique</li><li>Au moyen de commandes PowerShell</li><li>À distance via WinRM</li></ul></li></ul></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>Faites la partie 2 du <a href="/b64-scriptage-sous-windows/tp/tp2#partie-2-script-de-d%C3%A9ploiement">TP2</a>.</p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>La présentation PowerPoint est sur le Teams du cours, sous le canal Général &gt; Fichiers &gt; Supports de cours.</p></div></div></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="wmi-à-distance">WMI à distance<a href="#wmi-à-distance" class="hash-link" aria-label="Lien direct vers WMI à distance" title="Lien direct vers WMI à distance">​</a></h2><p>On peut lancer des requêtes WMI à distance sur une machine du réseau, en spécifiant le paramètre <code>-ComputerName</code> de la commande <code>Get-WmiObject</code>.</p><p>Pour que ce soit possible, il faut s&#x27;assurer de plusieurs choses:</p><ul><li>La machine distante est joignable sur le réseau</li><li>Le service WMI (winmgmt) est actif sur la machine distante (c&#x27;est le cas par défaut)</li><li>Nous avons des droits d&#x27;administration sur la machine distante</li><li>Le pare-feu laisse passer le trafic WMI</li></ul><p>Lorsque les machines sont membres du domaine et que nous sommes authentifiés avec un compte qui possède des droits d&#x27;administration sur les machines (c&#x27;est le cas du compte d&#x27;admin du domaine), il suffit de préciser le nom de la machine et les requêtes se font à travers le réseau.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/wmi_remote_01-4a779f1c3c5b6afaf57e2d672b46d75c.png" width="867" height="238" class="img_ev3q"></p><p>Le paramètre <code>-ComputerName</code> est de type <code>string[]</code>, donc il est possible de lui donner plusieurs ordinateurs, ou encore de lui passer un tableau de strings.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/wmi_remote_02-f6c29858e3258baf5895dbad101dabba.png" width="867" height="178" class="img_ev3q"></p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/wmi_remote_03-a7ba7759d639dcdce16763347172d17b.png" width="867" height="188" class="img_ev3q"></p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>astuce</div><div class="admonitionContent_S0QG"><p>Même si le nom du paramètre suggère qu&#x27;on doive passer un nom d&#x27;ordinateur, on peut aussi passer l&#x27;adresse IP numérique de l&#x27;ordinateur ou encore le nom DNS complet (FQDN). Dans un environnement de domaine simple, on tend souvent à n&#x27;indiquer que le nom de l&#x27;ordinateur, puisque les machines membres du domaine vont automatiquement appliquer le suffixe DNS de leur domaine. </p><p>Concernant les résolutions de nom court: Par exemple, si on tente de résoudre le serveur <em>SRV01</em> sur une machine client membre du domaine <em>auto.cemti.ca</em>, la résolution réelle se fera sur <em>SRV01.auto.cemti.ca</em>. </p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="préparation">Préparation<a href="#préparation" class="hash-link" aria-label="Lien direct vers Préparation" title="Lien direct vers Préparation">​</a></h3><p>Dans plusieurs cas, l&#x27;administration à distance de Windows est désactivée pour des raisons de sécurité. On l&#x27;active au besoin. Dans plusieurs entreprises, où la gestion des ordinateurs à distance est importante, ces configurations sont automatisées.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="pare-feu">Pare-feu<a href="#pare-feu" class="hash-link" aria-label="Lien direct vers Pare-feu" title="Lien direct vers Pare-feu">​</a></h4><p>WMI repose sur DCOM et RPC, deux protocoles d&#x27;administration à distance intégrés à Windows. Ceux-ci sont actifs par défaut sous Windows, mais le pare-feu bloque le trafic provenant de l&#x27;extérieur. Pour permettre de passer des requêtes WMI à une machine distante, il faut ouvrir le pare-feu des machine sur lesquelles vous voulez vous connecter.</p><p>Pour ce faire, démarrez la console avancée du pare-feu de Windows (wf.msc) et activez l&#x27;ensemble de règles du groupe &quot;Windows Management Instrumentation&quot;.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/wmi_remote_04-14a90b23a5ec976cbc34bf06cde18634.png" width="571" height="140" class="img_ev3q"></p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/wmi_remote_05-881d904a1c1f18076af02fced0239843.png" width="738" height="395" class="img_ev3q"></p><p>Vous pouvez maintenant tester la connexion en spécifiant les paramètres <code>ComputerName</code> et <code>Credential</code> (si nécessaire).</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/wmi_remote_06-729a728ebbb57bbbf76993d3affc053c.png" width="869" height="215" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="get-credential">Get-Credential<a href="#get-credential" class="hash-link" aria-label="Lien direct vers Get-Credential" title="Lien direct vers Get-Credential">​</a></h3><p>Pour administrer une machine à distance, il faut minimalement avoir les privilèges pour l&#x27;administrer.</p><p>Dans un domaine Active Directory, l&#x27;authentification est généralement intégrée. Lorsque vous ouvrez une session sur votre machine avec votre compte AD, c&#x27;est ce même compte qui sera automatiquement passé à la machine distante que vous tentez d&#x27;administrer. Cela simplifie beaucoup les choses.</p><p>Lorsqu&#x27;on veut poser une action sur un serveur distant avec un compte différent de celui dont on s&#x27;est servi pour s&#x27;authentifier à notre machine, une manière de procéder est par l&#x27;emploi de la commande <code>Get-Credential</code>.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/pscredential_01-c4a520ec11f77d9861d756e87cddb1cb.png" width="708" height="382" class="img_ev3q"></p><p>L&#x27;objet retourné est de type <code>PSCredential</code> et est le type d&#x27;objet à passer lorsqu&#x27;une commande possède un paramètre <code>Credential</code></p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/pscredential_02-730ca80f852002f9541b400d4f798644.png" width="869" height="270" class="img_ev3q"></p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>astuce</div><div class="admonitionContent_S0QG"><p>On ne devrait jamais utiliser <code>Get-Credential</code> dans un script ou une fonction, car cela force une action de l&#x27;utilisateur même s&#x27;il possède déjà des droits suffisants. Ça l&#x27;obligerait à se réauthentifier à chaque lancement du script. On ne devrait utiliser <code>Get-Credential</code> que lorsque l&#x27;utilisateur doit utiliser un compte différent que celui avec lequel il opère sa session PowerShell.</p><p>En fait, on devrait plutôt créer un paramètre <code>-Credential</code> non-obligatoire dont la valeur par défaut est un jeton vide.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token namespace">[CmdletBinding()]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">Param</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token namespace">[System.Management.Automation.PSCredential]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token variable" style="color:rgb(9, 134, 88)">$Credential</span><span class="token plain"> = </span><span class="token namespace">[System.Management.Automation.PSCredential]</span><span class="token plain">::Empty</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>On passe alors <code>$Credential</code> dans les paramètres <code>-Credential</code> des commandes qui sont appelées. Si le paramètre n&#x27;a pas été spécifié au lancement du script, le jeton est vide, et cela indique à la commande d&#x27;exécuter la commande au nom de l&#x27;utilisateur qui l&#x27;appelle.</p><p><code>Get-Credential</code> devrait seulement être utilisé au moment d&#x27;appeler le script, au besoin.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">\MonScript</span><span class="token punctuation" style="color:rgb(4, 81, 165)">.</span><span class="token plain">ps1 </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">Credential </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token function" style="color:rgb(0, 0, 255)">Get-Credential</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="objets-pscredential">Objets PSCredential<a href="#objets-pscredential" class="hash-link" aria-label="Lien direct vers Objets PSCredential" title="Lien direct vers Objets PSCredential">​</a></h3><p>Creusons un peu dans l&#x27;objet <code>PSCredential</code>.</p><p>Cet objet possède deux propriétés: <code>UserName</code> et <code>Password</code>.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/pscredential_04-9c34a7eda707e5883b007a7229fb8aa3.png" width="989" height="349" class="img_ev3q"></p><p>Pourtant, le mot de passe n&#x27;est pas visible. Il s&#x27;agit d&#x27;un objet <code>SecureString</code>.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/pscredential_05-f0ba38769a6f82c5321a282d304ec67c.png" width="989" height="212" class="img_ev3q"></p><p>Les objets <code>SecureString</code> servent principalement à stocker des mots de passe de manière sécuritaire. On peut leur affecter une chaîne de caractères, mais on ne peut pas la lire. Le mot de passe contenu dans cet objet est chiffré.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/pscredential_06-47c32e118e7b71803836bb20352a425e.png" width="989" height="506" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rpc-et-winrm">RPC et WinRM<a href="#rpc-et-winrm" class="hash-link" aria-label="Lien direct vers RPC et WinRM" title="Lien direct vers RPC et WinRM">​</a></h3><p>Le système d&#x27;exploitation Windows offre plusieurs options pour permettre aux administrateurs systèmes de les administrer à distance, à travers le réseau.</p><p>Nous avons vu précédemment comment les requêtes WMI, à l&#x27;aide de la commande <code>Get-WmiObject</code>, peuvent être passées à des hôtes distants. C&#x27;est possible au moyen du protocole RPC (Remote Procedure Call), un protocole datant des années 80. Microsoft a utilisé RPC dans ses outils de gestion dès les débuts de Windows NT, dans les années 90, et est encore aujourd&#x27;hui largement utilisé. C&#x27;est ce protocole qui permet l&#x27;administration à distance avec WMI et les consoles de gestion MMC (comme Computer Management).</p><p>RPC n&#x27;a pas été conçu pour la sécurité, qui n&#x27;était pas un grand enjeu à l&#x27;époque. Microsoft a fait évoluer le protocole, lui greffant des routines de sécurité, mais ça a donné un protocole très complexe et fragile. La nature du protocole oblige, entre autres, à ouvrir un très grand nombre de ports entrants (tous les ports de 1024-65535, éventuellement réduit à 49152-65535), ce qui élargit la surface d&#x27;exposition à des menaces extérieures. Aussi, le trafic RPC n&#x27;est généralement pas chiffré (à l&#x27;exception des credentials).</p><p>Microsoft a donc développé un nouveau protocole d&#x27;administration à distance pour Windows, avec cette fois-ci la sécurité en tête. Ce protocole, c&#x27;est WinRM. Il est basé sur HTTP/HTTPS, comme pour le Web.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="activation-de-winrm-sur-un-serveur">Activation de WinRM sur un serveur<a href="#activation-de-winrm-sur-un-serveur" class="hash-link" aria-label="Lien direct vers Activation de WinRM sur un serveur" title="Lien direct vers Activation de WinRM sur un serveur">​</a></h3><p>Pour activer WinRM sur une machine (la machine qui va recevoir la connexion), on peut utiliser la commande suivante, dans une console powershell élevée (en tant qu&#x27;administrateur)</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">Enable-PSRemoting</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">Force</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Si WinRM est déjà activé, la commande vous le dira. Sinon, la commande se chargera d&#x27;activer WinRM pour vous, incluant le service et le pare-feu.</p><p>On peut également utiliser la commande winrm quickconfig pour arriver au même résultat.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>astuce</div><div class="admonitionContent_S0QG"><p>Si votre serveur n&#x27;est pas dans un domaine, on peut activer WinRM mais la procédure est différente.</p><p>Comme le profil de connexion n&#x27;est pas celle d&#x27;un domaine, Windows le considère moins sécuritaire. Si votre serveur est connecté dans un environnement que vous considérez sécuritaire (un réseau local d&#x27;entreprise par exemple), vous pouvez demander de sauter la vérification.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">Enable-PSRemoting</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">Force </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">SkipNetworkProfileCheck</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Aussi, il faut préciser la liste des machines de confiance. Lorsqu&#x27;on est dans un domaine, toutes les machines membres du domaine sont dignes de confiance. Lorsqu&#x27;on n&#x27;est pas dans un domaine, on doit les définir.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">Set-Item</span><span class="token plain"> WSMAN:\localhost\Client\TrustedHosts </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">Value </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;192.168.123.45&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">Force</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Si vous voulez accepter la connexion de n&#x27;importe quelle machine du réseau, vous pouvez mettre * comme valeur. Mais sachez que ce n&#x27;est pas une bonne pratique de sécurité.</p><p>Ensuite, redémarrez le service WinRM pour que les changements soient pris en compte.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token function" style="color:rgb(0, 0, 255)">Restart-Service</span><span class="token plain"> WinRM</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="le-pare-feu">Le pare-feu<a href="#le-pare-feu" class="hash-link" aria-label="Lien direct vers Le pare-feu" title="Lien direct vers Le pare-feu">​</a></h4><p>Normalement, la règle de pare-feu est créée automatiquement. Vous pouvez vous en assurer dans la console du pare-feu (wf.msc).</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/winrm_firewall01-ab400d5132e59da13aeec10e56736035.png" width="810" height="281" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="chiffrement">Chiffrement<a href="#chiffrement" class="hash-link" aria-label="Lien direct vers Chiffrement" title="Lien direct vers Chiffrement">​</a></h4><p>Une bonne pratique, lorsqu&#x27;on active WinRM, est de permettre le chiffrement du trafic. Par défaut, c&#x27;est HTTP qui est utilisé et pas HTTPS. Pour permettre le chiffrement du trafic, tout comme avec HTTPS pour le Web, on a besoin d&#x27;un certificat SSL. On n&#x27;entrera pas dans ces détails dans le cadre de ce cours, mais si ça vous intéresse, consultez ce guide: <a href="https://4sysops.com/archives/powershell-remoting-over-https-with-a-self-signed-ssl-certificate/" target="_blank" rel="noopener noreferrer">https://4sysops.com/archives/powershell-remoting-over-https-with-a-self-signed-ssl-certificate/</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sessions-powershell-à-distance">Sessions PowerShell à distance<a href="#sessions-powershell-à-distance" class="hash-link" aria-label="Lien direct vers Sessions PowerShell à distance" title="Lien direct vers Sessions PowerShell à distance">​</a></h2><p>Une fois que WinRM a été activé sur le serveur, vous pouvez maintenant vous y ouvrir une session PowerShell distante. Pour ce faire, utilisez les commandes dont le nom est PSSession.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_01-79f4fd51a3f0c7c8416b8e2543631aec.png" width="510" height="360" class="img_ev3q"></p><p>Pour accéder à la ligne de commande à distance, la commande à utiliser est <code>Enter-PSSession</code>.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_02-0baf0ac22364e937d2275df43483afe3.png" width="621" height="109" class="img_ev3q"></p><p>Une fois dans la session distante, on voit le nom du serveur dans l&#x27;invite. Toutes les commandes qu&#x27;on tape ici seront faites comme si nous étions physiquement sur le serveur.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_03-f8e9936d6baadfaac6bc9d2bb9e19637.png" width="681" height="233" class="img_ev3q"></p><p>Pour quitter la session, vous pouvez utiliser la commande <code>Exit-PSSession</code>.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_04-4647b1f82529f6ab1ea2ef7603e18bda.png" width="654" height="118" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="authentification">Authentification<a href="#authentification" class="hash-link" aria-label="Lien direct vers Authentification" title="Lien direct vers Authentification">​</a></h3><p>Dans un environnement Active Directory, on se connecte au serveur distant en utilisant par défaut l&#x27;identité de l&#x27;utilisateur présentement loggé. On peut utiliser le paramètre <code>-Credential</code> pour spécifier un utilisateur différent.</p><p>En entreprise, il n&#x27;est pas rare de recourir à cette façon de faire. Les utilisateurs (même les admins) utilisent un compte régulier, sans droits d&#x27;administration, pour travailler sur leur poste de travail. Ils ont un deuxième compte, qu&#x27;ils utilisent pour se connecter à des sessions distantes, et c&#x27;est ce compte qui possède les droits d&#x27;administration.</p><p>Dans cet exemple, l&#x27;utilisateur du système est loggé avec le compte alice, qui n&#x27;a aucun droit d&#x27;administration. Lorsqu&#x27;on tente de se connecter sur le serveur, l&#x27;accès est refusé.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_auth_01-baf9bf3c09ac2f3c208ecbaf24694a6e.png" width="987" height="335" class="img_ev3q"></p><p>Pour se connecter en tant qu&#x27;un utilisateur qui possède des droits sur ce système, il faut spécifier les credentials. On les obtient avec <code>Get-Credential</code>.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_auth_02-a3ae175d4cfd49d1de2c7cf02e4a8a99.png" width="543" height="434" class="img_ev3q"></p><p>Et on passe cet objet dans le paramètre -Credential.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_auth_03-b071515592a6aa60d841f8a0f497350b.png" width="708" height="206" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="créer-des-sessions-powershell">Créer des sessions PowerShell<a href="#créer-des-sessions-powershell" class="hash-link" aria-label="Lien direct vers Créer des sessions PowerShell" title="Lien direct vers Créer des sessions PowerShell">​</a></h3><p>Les sessions interactives, c&#x27;est bien, mais on doit faire toutes nos commandes dans l&#x27;ordinateur distant. Si on a un script à exécuter, il faut d&#x27;abord le transférer sur l&#x27;ordinateur distant, ce qui n&#x27;est pas pratique.</p><p>On peut ouvrir des sessions PowerShell à distance, non pas pour accéder à la console, mais pour y lancer des commandes.</p><p>Créer la session</p><p>On créer une nouvelle session avec la commande <code>New-PSSession</code>. Celle-ci sera ouverte et portera un numéro d&#x27;identification.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_05-389e1e20e6aeb3f4af0c6965e1535693.png" width="912" height="195" class="img_ev3q"></p><p>Obtenir les sessions existantes</p><p>On peut obtenir l&#x27;état des sessions en cours avec <code>Get-PSSession</code>.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_06-b27c8a3097e48144dc4e07b65d67008e.png" width="856" height="209" class="img_ev3q"></p><p>Affecter une session à une variable</p><p>Pour obtenir une session spécifique et la mettre dans une variable, on peut l&#x27;affecter avec <code>Get-PSSession</code> si la session est déjà ouverte, ou encore, l&#x27;affecter directement avec <code>New-PSSession</code>.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_07-822e87d6dcbc72facc753d7bb8c2f6f9.png" width="860" height="219" class="img_ev3q"></p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_08-7033312a55483d99dc3e1e2d80b48274.png" width="893" height="333" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="terminer-une-session">Terminer une session<a href="#terminer-une-session" class="hash-link" aria-label="Lien direct vers Terminer une session" title="Lien direct vers Terminer une session">​</a></h4><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_09-10edea638bdd05eb2a908f09155505c1.png" width="631" height="142" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="terminer-toutes-les-sessions-ouvertes">Terminer toutes les sessions ouvertes<a href="#terminer-toutes-les-sessions-ouvertes" class="hash-link" aria-label="Lien direct vers Terminer toutes les sessions ouvertes" title="Lien direct vers Terminer toutes les sessions ouvertes">​</a></h4><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_10-7b520530c7ff0f26ebc26ce3b365a4a7.png" width="582" height="135" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="invoke-command">Invoke-Command<a href="#invoke-command" class="hash-link" aria-label="Lien direct vers Invoke-Command" title="Lien direct vers Invoke-Command">​</a></h3><p>La commande Invoke-Command exécute une commande à distance. Elle est équivalente à appeler powershell.exe sur la machine distante.</p><p>On peut l&#x27;utiliser de deux manières.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="exécuter-un-bloc-de-commandes">Exécuter un bloc de commandes<a href="#exécuter-un-bloc-de-commandes" class="hash-link" aria-label="Lien direct vers Exécuter un bloc de commandes" title="Lien direct vers Exécuter un bloc de commandes">​</a></h4><p>Le bloc de commandes se définit avec le paramètre <code>-ScriptBlock</code>, entre accolades. C&#x27;est pratique pour lancer une commande simple sur les machines distantes.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_invoke-command_01-847b111d7162dc08fa5efa9d2565254b.png" width="864" height="220" class="img_ev3q"></p><div class="theme-admonition theme-admonition-caution alert alert--warning admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>attention</div><div class="admonitionContent_S0QG"><p>Une session PSSession à distance correspond à une session PowerShell ouverte sur une autre machine. Par conséquent, elle est distincte de la session locale. Par exemple, une variable qu&#x27;on définit dans la session locale ne sera pas accessible sur la session distante.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token variable" style="color:rgb(9, 134, 88)">$NouveauDossier</span><span class="token plain"> = </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;C:\MonDossier&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token variable" style="color:rgb(9, 134, 88)">$Session</span><span class="token plain"> = </span><span class="token function" style="color:rgb(0, 0, 255)">New-PSSession</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">ComputerName </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;SRV01&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">Invoke-Command</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">Session </span><span class="token variable" style="color:rgb(9, 134, 88)">$Session</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">ScriptBlock </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">New-Item</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(9, 134, 88)">$NouveauDossier</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">ItemType Directory  </span><span class="token comment" style="color:rgb(0, 128, 0)"># Ne fonctionnera pas!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>L&#x27;exemple précédent ne fonctionnera pas, puisque la variable <code>$NouveauDossier</code> n&#x27;a jamais été créée dans la session distante. Elle n&#x27;existe que dans la session locale.</p><p>Pour pouvoir récupérer une variable locale dans un bloc de code à envoyer à une machine distante, il faut utiliser le préfixe <code>$using:</code> avant le nom de la variable.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token variable" style="color:rgb(9, 134, 88)">$NouveauDossier</span><span class="token plain"> = </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;C:\MonDossier&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token variable" style="color:rgb(9, 134, 88)">$Session</span><span class="token plain"> = </span><span class="token function" style="color:rgb(0, 0, 255)">New-PSSession</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">ComputerName </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;SRV01&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">Invoke-Command</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">Session </span><span class="token variable" style="color:rgb(9, 134, 88)">$Session</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">ScriptBlock </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">New-Item</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">Path </span><span class="token variable" style="color:rgb(9, 134, 88)">$using</span><span class="token plain">:NouveauDossier </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">ItemType Directory</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>On peut aussi effectuer un <em>splatting</em> avec un hashtable défini localement dans une commande distante avec le préfixe <code>@using:</code>, de la même manière.</p><div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token variable" style="color:rgb(9, 134, 88)">$NouveauDossierSplat</span><span class="token plain"> = @</span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    Path = </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;C:\MonDossier&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    ItemType = </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;Directory&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token variable" style="color:rgb(9, 134, 88)">$Session</span><span class="token plain"> = </span><span class="token function" style="color:rgb(0, 0, 255)">New-PSSession</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">ComputerName </span><span class="token string" style="color:rgb(163, 21, 21)">&quot;SRV01&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token function" style="color:rgb(0, 0, 255)">Invoke-Command</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">Session </span><span class="token variable" style="color:rgb(9, 134, 88)">$Session</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">-</span><span class="token plain">ScriptBlock </span><span class="token punctuation" style="color:rgb(4, 81, 165)">{</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token function" style="color:rgb(0, 0, 255)">New-Item</span><span class="token plain"> @</span><span class="token keyword" style="color:rgb(0, 0, 255)">using</span><span class="token plain">:NouveauDossierSplat</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="exécuter-un-script">Exécuter un script<a href="#exécuter-un-script" class="hash-link" aria-label="Lien direct vers Exécuter un script" title="Lien direct vers Exécuter un script">​</a></h4><p>Lorsqu&#x27;on a un plus grand nombre de commandes à lancer sur la machine distante, on peut appeler un script.</p><p>Dans cet exemple, on crée un script tout simple composé seulement de la commande <code>Get-Process</code>, mais ça pourrait être un script beaucoup plus complexe. Ce script sera lancé dans la session distante.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_invoke-command_02-e3e99ef765c9aeb2f3e8c2745b2fc4c3.png" width="859" height="274" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="spécifier-les-noms-de-machines-au-lieu-des-sessions">Spécifier les noms de machines au lieu des sessions<a href="#spécifier-les-noms-de-machines-au-lieu-des-sessions" class="hash-link" aria-label="Lien direct vers Spécifier les noms de machines au lieu des sessions" title="Lien direct vers Spécifier les noms de machines au lieu des sessions">​</a></h4><p>On peut aussi créer les sessions automatiquement, en spécifiant les noms de machines plutôt que des sessions, mais si vous avez plusieurs commandes à lancer, il sera plus pratique de réutiliser la même session pour chacune des commandes au lieu de les réinitier à chaque fois.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_invoke-command_03-3eb0109e76f7529cf1b32b4767d8b50b.png" width="918" height="208" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="psremoting-et-pipeline">PSRemoting et pipeline<a href="#psremoting-et-pipeline" class="hash-link" aria-label="Lien direct vers PSRemoting et pipeline" title="Lien direct vers PSRemoting et pipeline">​</a></h3><p>Comme c&#x27;est une session PowerShell, ce qui sort de la commande distante, c&#x27;est un objet. Et cet objet sort sur le pipeline local du client. Autrement dit, quand la commande est lancée à distance, ce qu&#x27;elle laisse dans le pipeline revient à l&#x27;appelant, et nous pouvons manipuler cet objet à notre guise.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_invoke-command_04-7e7d2b98b8d2e382d411b87e24a83661.png" width="987" height="294" class="img_ev3q"></p><p>On peut aussi affecter cet objet dans une variable.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_invoke-command_05-60552e02bd41a339dc1391c1cc6d3c42.png" width="987" height="310" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="plusieurs-sessions-en-même-temps">Plusieurs sessions en même temps<a href="#plusieurs-sessions-en-même-temps" class="hash-link" aria-label="Lien direct vers Plusieurs sessions en même temps" title="Lien direct vers Plusieurs sessions en même temps">​</a></h3><p>On peut lancer une commande sur plusieurs sessions d&#x27;un coup. </p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_invoke-command_06-9240c20bade96126117d8fe5f88b6fae.png" width="987" height="438" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="copie-de-fichiers-à-travers-une-session">Copie de fichiers à travers une session<a href="#copie-de-fichiers-à-travers-une-session" class="hash-link" aria-label="Lien direct vers Copie de fichiers à travers une session" title="Lien direct vers Copie de fichiers à travers une session">​</a></h3><p>Il est possible de copier un fichier à travers une session PSRemoting à l&#x27;aide de la commande <code>Copy-Item</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="de-la-machine-locale-vers-la-machine-distante">De la machine locale vers la machine distante<a href="#de-la-machine-locale-vers-la-machine-distante" class="hash-link" aria-label="Lien direct vers De la machine locale vers la machine distante" title="Lien direct vers De la machine locale vers la machine distante">​</a></h4><p>Si on spécifie le paramètre <code>-ToSession</code>, on envoie le fichier vers la machine cible. Le paramètre -Path représente donc le chemin sur la machine locale, et le paramètre -Destination représente le chemin sur la machine distante.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_copy-item_01-9a5c9aa65d7f977b8df9fecaf6a965cc.png" width="900" height="135" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="de-la-machine-distante-vers-la-machine-locale">De la machine distante vers la machine locale<a href="#de-la-machine-distante-vers-la-machine-locale" class="hash-link" aria-label="Lien direct vers De la machine distante vers la machine locale" title="Lien direct vers De la machine distante vers la machine locale">​</a></h4><p>À l&#x27;inverse, si on spécifie le paramètre <code>-FromSession</code>, alors on tire le fichier de l&#x27;ordinateur distant vers l&#x27;ordinateur local. Le paramètre <code>-Path</code> représente alors le chemin sur la machine distante, et le paramètre <code>-Destination</code>, celui sur la machine locale.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/psremoting_copy-item_02-c5140316a06de6dd09d33060091ed26b.png" width="900" height="135" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="le-planificateur-de-tâches">Le planificateur de tâches<a href="#le-planificateur-de-tâches" class="hash-link" aria-label="Lien direct vers Le planificateur de tâches" title="Lien direct vers Le planificateur de tâches">​</a></h2><p>Le planificateur de tâches sert, comme son nom l&#x27;indique, à planifier des opérations sous Windows afin qu&#x27;elles démarrent automatiquement selon certains critères et dans certaines conditions. Il est très utile dans de nombreux contextes, comme la planification de tâches de maintenance régulières, le démarrage d&#x27;opérations automatique au démarrage du système ou à l&#x27;ouverture d&#x27;une session utilisateur, le nettoyage automatique de fichiers temporaires, la prise de sauvegardes régulières, etc.</p><p>Avec l&#x27;interface graphique, on utilise la console MMC du planificateur de tâches, <code>taskschd</code>, ou encore la console de gestion de l&#x27;ordinateur, <code>compmgmt.msc</code>.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_01-083757c0f53310935feb5cdd4e98ea8d.png" width="448" height="252" class="img_ev3q"></p><p>Les tâches planifiées sont organisées sous forme d&#x27;arborescence. La racine (nommée &quot;bibliothèque du planificateur de tâches&quot;, ou simplement, <strong>/</strong>) contient un certain nombre de tâches planifiées déjà mises en place à l&#x27;installation de Windows ou d&#x27;un logiciel, mais d&#x27;autres tâches sont stockées dans des conteneurs sous la racine.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_02-56d205cd86506626b5a50f4fbd96e63b.png" width="572" height="446" class="img_ev3q"></p><p>Pour créer une tâche à l&#x27;aide de l&#x27;interface graphique, il suffit d&#x27;ouvrir le menu contextuel par un clic-droit sur le conteneur où créer la tâche. Il existe deux manière de créer une tâche: simplifiée (&quot;<em>créer une tâche de base...</em>&quot;) et avancée (&quot;<em>créer une tâche...</em>&quot;). Il est préférable de ne pas choisir une tâche de base, puisque certaines options sont inaccessibles.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_03-dd911f0b064bd012be01833832e1b049.png" width="486" height="422" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="composition-dune-tâche-planifiée">Composition d&#x27;une tâche planifiée<a href="#composition-dune-tâche-planifiée" class="hash-link" aria-label="Lien direct vers Composition d&#x27;une tâche planifiée" title="Lien direct vers Composition d&#x27;une tâche planifiée">​</a></h3><p>Une tâche planifiée est en ensemble de plusieurs éléments d&#x27;information. Ils sont assemblés ensemble pour former une tâche planifiée incrite dans le planificateur.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_05-9a17c24b66a27486d7717196943ce633.png" width="371" height="270" class="img_ev3q"></p><ul><li><p>L&#x27;information d&#x27;enregistrement (<strong>RegistrationInfo</strong>) contient les propriétés de la tâche qui concernent son enregistrement dans le planificateur, comme le nom de la tâche, sa description et son emplacement dans l&#x27;arborescence du planificateur.</p></li><li><p>Les déclencheurs (<strong>Trigger</strong>) définissent dans quelle circonstance la tâche pourra être lancée. Par exemple, au démarrage de l&#x27;ordinateur, à l&#x27;ouverture de session, à chaque vendredi minuit, ou même lorsqu&#x27;un événement système est détecté. Il peut y en avoir plus d&#x27;un.</p></li><li><p>Les actions (<strong>Action</strong>) définissent une action (comme le lancement d&#x27;une commande ou d&#x27;un script) à exécuter chaque fois que la tâche est déclenchée. Il peut y en avoir plusieurs.</p></li><li><p>Le principal de sécurité (<strong>Principal</strong>) décrit avec quelle identité (un compte utilisateur ou un groupe) la tâche sera lancée. Si le principal est un compte utilisateur, alors c&#x27;est sous ce compte que la tâche sera exécutée (comme si l&#x27;utilisateur l&#x27;avait fait manuellement). Si le principal est un groupe, la tâche sera lancée au nom de l&#x27;utilisateur courant uniquement s&#x27;il est membre de ce groupe.</p></li><li><p>Les paramètres (<strong>Settings</strong>) décrivent diverses options concernant la tâche. Par exemple, la tâche doit-elle être exécutée même si l&#x27;ordinateur tourne sur la batterie, ou le comportement à adopter si la tâche échoue.</p></li></ul><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_04-1a8d02d3a5e551dbe924eb3e1953b1f2.png" width="808" height="490" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="déclencheur-trigger">Déclencheur (<em>Trigger</em>)<a href="#déclencheur-trigger" class="hash-link" aria-label="Lien direct vers déclencheur-trigger" title="Lien direct vers déclencheur-trigger">​</a></h3><p>Une tâche planifiée comprend un ou plusieurs déclencheurs, c&#x27;est-à-dire des événements qui démarreront automatiquement la tâche.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_trigger01-b0804a68d3ce0316080f1a7b63836829.png" width="856" height="534" class="img_ev3q"></p><p>Plusieurs types de déclencheurs sont disponibles:</p><ul><li>À l&#x27;heure programmée</li><li>À l&#x27;ouverture de session</li><li>Au démarage</li><li>Après une période d&#x27;activité </li><li>Sur un événement (système)</li><li>Lors de la création/modification de la tâche</li><li>Au moment de la connexion à une session utilisateur (par exemple, RDP)</li><li>Au moment de la déconnexion à une session utilisateur</li><li>Au verrouillage du poste de travail (Win+L)</li><li>Au déverrouillage du poste de travail</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="action-action">Action (<em>Action</em>)<a href="#action-action" class="hash-link" aria-label="Lien direct vers action-action" title="Lien direct vers action-action">​</a></h3><p>Une tâche planifiée comprend une ou plusieurs actions qui seront lancées lorsque la tâche sera déclenchée. Le principal type d&#x27;action est le lancement d&#x27;une commande (&quot;<em>démarrer un programme</em>&quot;).</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_action01-7000678738875d6441dedd82e6bcdcd7.png" width="642" height="246" class="img_ev3q"></p><p>Pour lancer une commande, il faut définir trois paramètres:</p><table><thead><tr><th>Paramètre</th><th>Description</th></tr></thead><tbody><tr><td>Programme/script</td><td>Le nom ou chemin du fichier exécutable à appeler seulement.</td></tr><tr><td>Ajouter des arguments (facultatif)</td><td>Tous les arguments après le nom de l&#x27;exécutable.</td></tr><tr><td>Commencer dans (facultatif)</td><td>Le répertoire de travail dans lequel lancer la commande.</td></tr></tbody></table><p>Par exemple, pour qu&#x27;une tâche exécute le script PowerShell <code>C:\Scripts\MonScript.ps1</code>, il faudrait que le nom du programme soit <code>powershell.exe</code> et que les arguments soient <code>-File C:\Scripts\MonScript.ps1 -ExecutionPolicy Bypass</code>.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_action02-8ebfbbf359478f172106f7c37269709c.png" width="464" height="299" class="img_ev3q"></p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>astuce</div><div class="admonitionContent_S0QG"><p>Pour connaître la syntaxe de la commande Powershell.exe, vous pouvez lancer <code>Powershell.exe /?</code> pour accéder à la rubrique d&#x27;aide.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_action03-05a32e074505d251f1289f42f4db7498.png" width="730" height="281" class="img_ev3q"></p></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="conditions-et-paramètres">Conditions et paramètres<a href="#conditions-et-paramètres" class="hash-link" aria-label="Lien direct vers Conditions et paramètres" title="Lien direct vers Conditions et paramètres">​</a></h3><p>Les onglets Conditions et Paramètres contiennent des options supplémentaires sur la tâche.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_condition01-92ea24c0d9d242fe1b1678d3faeda799.png" width="587" height="448" class="img_ev3q"></p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_parameters01-5f312503b665086d8c02d9009e6f02b0.png" width="587" height="448" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="forcer-le-lancement-une-tâche-planifiée">Forcer le lancement une tâche planifiée<a href="#forcer-le-lancement-une-tâche-planifiée" class="hash-link" aria-label="Lien direct vers Forcer le lancement une tâche planifiée" title="Lien direct vers Forcer le lancement une tâche planifiée">​</a></h3><p>On peut forcer l&#x27;exécution d&#x27;une tâche planifiée directement par la console. C&#x27;est pratique pour la tester.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_forceexec-605db66f9dce228b23b516bc841f9e30.png" width="1018" height="360" class="img_ev3q"></p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>astuce</div><div class="admonitionContent_S0QG"><p>Comme bien des consoles MMC, vous pouvez gérer les tâches planifiées sur une machine distante à partir de la console. Vous devez être administrateur local de la machine distante, et les pare-feux doivent laisser passer le protocole MSRPC.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_remote-36e7cf26e7430cd882f9875cb53b6d63.png" width="592" height="431" class="img_ev3q"></p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gestion-des-tâches-planifiées-en-powershell">Gestion des tâches planifiées en PowerShell<a href="#gestion-des-tâches-planifiées-en-powershell" class="hash-link" aria-label="Lien direct vers Gestion des tâches planifiées en PowerShell" title="Lien direct vers Gestion des tâches planifiées en PowerShell">​</a></h2><p>PowerShell offre un ensemble de commandes pour contrôler, localement ou à distance, les tâches planifiées.</p><p>Pour ce faire, il y a plusieurs commandes à faire, puisqu&#x27;il faut créer chaque élément de la tâche planifiée individuellement, puis les mettre ensemble pour l&#x27;enregistrer dans la bibliothèque du planificateur de tâches.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="définir-le-déclencheur">Définir le déclencheur<a href="#définir-le-déclencheur" class="hash-link" aria-label="Lien direct vers Définir le déclencheur" title="Lien direct vers Définir le déclencheur">​</a></h3><p>Il existe plusieurs déclencheurs. Il suffit ici de créer un nouveau déclencheur du type souhaité. Il faut le stocker dans une variable.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_posh_newtrigger-2a4df83a3f2aedbd6a68dc8dd513c4ac.png" width="730" height="235" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="définir-laction">Définir l&#x27;action<a href="#définir-laction" class="hash-link" aria-label="Lien direct vers Définir l&#x27;action" title="Lien direct vers Définir l&#x27;action">​</a></h3><p>Il faut définir l&#x27;action, soit le programme a exécuter. Tout comme avec l&#x27;interface graphique, le programme à spécifier dans le paramètre -Execute n&#x27;est que l&#x27;exécutable à lancer. Si c&#x27;est un script PowerShell, alors on met &quot;powershell.exe&quot;. Si c&#x27;est un autre programme, on met uniquement le nom du programme, sans ses arguments.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_posh_newaction-bfed654b1bc0efd5baa42f035aea0429.png" width="730" height="236" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="définir-le-principal">Définir le principal<a href="#définir-le-principal" class="hash-link" aria-label="Lien direct vers Définir le principal" title="Lien direct vers Définir le principal">​</a></h3><p>Le principal désigne l&#x27;utilisateur au nom duquel la tâche sera exécutée.</p><p>Nous avons deux options:</p><ul><li>Spécifier un compte utilisateur spécifique (<code>-UserID</code>)</li><li>Spécifier un groupe (<code>-GroupID</code>)</li></ul><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_posh_newprincipal-f2f891a7988f86454900f958ff4f0a29.png" width="730" height="266" class="img_ev3q"></p><p>Si le principal est un utilisateur, la tâche sera faite au nom de ce compte précis.</p><p>Si le principal est un groupe, la tâche sera faite au nom de l&#x27;utilisateur courant, uniquement si celui-ci fait partie du groupe. Lorsque le principal est un groupe, il est impossible que la tâche soit lancée lorsque l&#x27;utilisateur n&#x27;est pas loggé.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="enregistrer-la-tâche-planifiée">Enregistrer la tâche planifiée<a href="#enregistrer-la-tâche-planifiée" class="hash-link" aria-label="Lien direct vers Enregistrer la tâche planifiée" title="Lien direct vers Enregistrer la tâche planifiée">​</a></h3><p>Une fois tous les éléments en place, il ne reste plus qu&#x27;à enregistrer la tâche planifiée. On lui donne alors un nom, une description et un emplacement dans le planificateur, puis on lui donne une ou plusieurs actions, un ou plusieurs déclencheurs ainsi qu&#x27;un principal.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_posh_register-5eaa05a642ff6ffa5511c846858d32cc.png" width="729" height="181" class="img_ev3q"></p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>astuce</div><div class="admonitionContent_S0QG"><p>Il est aussi possible de contrôler les tâches planifiées sur un ordinateur distant. On peut simplement passer par une session distante (PSSession) au moyen de la commande Invoke-Command.</p><p><img loading="lazy" src="/b64-scriptage-sous-windows/assets/images/taskschd_posh_remote01-ef50b093f8354149583ef12a4eb6bcb9.png" width="570" height="270" class="img_ev3q"></p></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Dernière mise à jour<!-- --> le <b><time datetime="2023-11-14T21:35:00.000Z">14 nov. 2023</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Pages de documentation"><a class="pagination-nav__link pagination-nav__link--prev" href="/b64-scriptage-sous-windows/cours/09"><div class="pagination-nav__sublabel">Précédent</div><div class="pagination-nav__label">R09 - Requêtes WMI</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/b64-scriptage-sous-windows/cours/11"><div class="pagination-nav__sublabel">Suivant</div><div class="pagination-nav__label">R11 - Travail pratique 2</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#wmi-à-distance" class="table-of-contents__link toc-highlight">WMI à distance</a><ul><li><a href="#préparation" class="table-of-contents__link toc-highlight">Préparation</a></li><li><a href="#get-credential" class="table-of-contents__link toc-highlight">Get-Credential</a></li><li><a href="#objets-pscredential" class="table-of-contents__link toc-highlight">Objets PSCredential</a></li><li><a href="#rpc-et-winrm" class="table-of-contents__link toc-highlight">RPC et WinRM</a></li><li><a href="#activation-de-winrm-sur-un-serveur" class="table-of-contents__link toc-highlight">Activation de WinRM sur un serveur</a></li></ul></li><li><a href="#sessions-powershell-à-distance" class="table-of-contents__link toc-highlight">Sessions PowerShell à distance</a><ul><li><a href="#authentification" class="table-of-contents__link toc-highlight">Authentification</a></li><li><a href="#créer-des-sessions-powershell" class="table-of-contents__link toc-highlight">Créer des sessions PowerShell</a></li><li><a href="#invoke-command" class="table-of-contents__link toc-highlight">Invoke-Command</a></li><li><a href="#psremoting-et-pipeline" class="table-of-contents__link toc-highlight">PSRemoting et pipeline</a></li><li><a href="#plusieurs-sessions-en-même-temps" class="table-of-contents__link toc-highlight">Plusieurs sessions en même temps</a></li><li><a href="#copie-de-fichiers-à-travers-une-session" class="table-of-contents__link toc-highlight">Copie de fichiers à travers une session</a></li></ul></li><li><a href="#le-planificateur-de-tâches" class="table-of-contents__link toc-highlight">Le planificateur de tâches</a><ul><li><a href="#composition-dune-tâche-planifiée" class="table-of-contents__link toc-highlight">Composition d&#39;une tâche planifiée</a></li><li><a href="#déclencheur-trigger" class="table-of-contents__link toc-highlight">Déclencheur (<em>Trigger</em>)</a></li><li><a href="#action-action" class="table-of-contents__link toc-highlight">Action (<em>Action</em>)</a></li><li><a href="#conditions-et-paramètres" class="table-of-contents__link toc-highlight">Conditions et paramètres</a></li><li><a href="#forcer-le-lancement-une-tâche-planifiée" class="table-of-contents__link toc-highlight">Forcer le lancement une tâche planifiée</a></li></ul></li><li><a href="#gestion-des-tâches-planifiées-en-powershell" class="table-of-contents__link toc-highlight">Gestion des tâches planifiées en PowerShell</a><ul><li><a href="#définir-le-déclencheur" class="table-of-contents__link toc-highlight">Définir le déclencheur</a></li><li><a href="#définir-laction" class="table-of-contents__link toc-highlight">Définir l&#39;action</a></li><li><a href="#définir-le-principal" class="table-of-contents__link toc-highlight">Définir le principal</a></li><li><a href="#enregistrer-la-tâche-planifiée" class="table-of-contents__link toc-highlight">Enregistrer la tâche planifiée</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Sources</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/departement-info-cem/b64-scriptage-sous-windows" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Vincent Carrier. Tous droits réservés.</div></div></div></footer></div>
<script src="/b64-scriptage-sous-windows/assets/js/runtime~main.ade9795c.js"></script>
<script src="/b64-scriptage-sous-windows/assets/js/main.4c0c98db.js"></script>
</body>
</html>