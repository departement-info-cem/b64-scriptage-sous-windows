---
title: R05 - Gestion des comptes
slug: "05"
draft: false
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

# Rencontre 5 - Gestion des comptes

:::note R√©sum√© de la s√©ance

<Tabs>

<TabItem value="deroulement" label="üë®‚Äçüè´ D√©roulement du cours">

1. Rappel du cours pr√©c√©dent
1. Gestion des comptes locaux
1. Gestion des comptes de domaine
1. Git
1. Pr√©sentation du TP1

</TabItem>

<TabItem value="exercices" label="üíª Exercices √† compl√©ter">

- Travail pratique 1

</TabItem>

<TabItem value="ressources" label="üìö Ressources √† consulter">

La pr√©sentation PowerPoint est sur le Teams du cours, sous le canal G√©n√©ral > Fichiers > Supports de cours.

</TabItem>

</Tabs>

:::


## Gestion des comptes locaux

√Ä l'exception des contr√¥leurs de domaine, toutes les machines Windows, qu'elles soient d'une √©dition client (Windows 10 / 11) ou serveur, poss√®dent des utilisateurs locaux. Comme vous l'avez vu dans le cours de syst√®mes d'exploitation, les utilisateurs locaux peuvent √™tre g√©r√©s au moyen du composant enfichable "Utilisateurs et groupes locaux" dans une console MMC (accessible par lusrmgr.msc ou compmgmt.msc). Par d√©faut, lorsqu'on installe Windows, un certain nombre de comptes utilisateurs sont cr√©√©s, dont *Administrateur* et *Invit√©*.



Windows poss√®de √©galement un ensemble de groupes locaux pr√©d√©finis. On peut ajouter des comptes (locaux ou domaine) dans un groupe local. Certains groupes poss√®dent des privil√®ges particuliers, comme le groupe **Administrateurs**; tous les comptes utilisateurs membres de ce groupe disposent du **privil√®ge d'√©l√©vation** ("ex√©cuter en tant qu'admin"). Les membres du groupe **Utilisateurs**, quant √† eux, disposent du privil√®ge de **d√©marrage de session locale**. 

:::caution
Un utilisateur qui n'est pas membre d'un de ces groupes ne sera pas autoris√© √† d√©marrer une session.
:::

On peut utiliser PowerShell pour contr√¥ler les utilisateurs locaux, les groupes locaux ainsi que l'appartenance aux groupes locaux. PowerShell offre pour ce faire un module `Microsoft.PowerShell.LocalAccounts` qui renferme plusieurs commandes, notamment:

- `Add-LocalGroupMember`
- `Disable-LocalUser`
- `Enable-LocalUser`
- `Get-LocalGroup`
- `Get-LocalGroupMember`
- `Get-LocalUser`
- `New-LocalGroup`
- `New-LocalUser`
- `Remove-LocalGroup`
- `Remove-LocalGroupMember`
- `Remove-LocalUser`
- `Rename-LocalGroup`
- `Rename-LocalUser`
- `Set-LocalGroup`
- `Set-LocalUser`


### Consulter les utilisateurs existants

La commande Get-LocalUser permet d'obtenir la liste des utilisateurs locaux. Elle retourne un ou plusieurs objets de types `[Microsoft.PowerShell.Commands.LocalUser]` qui d√©crivent un compte utilisateur local.

<PowerShellWindow workdir="C:\" command="Get-LocalUser" result="
Name               Enabled Description 
----               ------- -----------
Administrateur     True    Compte d‚Äôutilisateur d‚Äôadministration
DefaultAccount     False   Compte utilisateur g√©r√© par le syst√®me.
Invit√©             False   Compte d‚Äôutilisateur invit√©
paul               True    Boss de la compagnie
WDAGUtilityAccount False   Compte d‚Äôutilisateur g√©r√© et utilis√© par le syst..."/>

Ces objets poss√®dent plusieurs informations sur le compte utilisateur. On peut les voir en explorant la structure de l'objet, par exemple avec `Select-Object *`.

<PowerShellWindow workdir="C:\" command="Get-LocalUser -Name 'paul' | Select-Object *" result="
AccountExpires         : 2023-05-12 20:06:27
Description            : Boss de la compagnie
Enabled                : True
FullName               : Paul Meilleur
PasswordChangeableDate : 2023-04-13 20:06:27
PasswordExpires        : 2023-05-24 20:06:27
UserMayChangePassword  : True
PasswordRequired       : False
PasswordLastSet        : 2023-04-12 20:06:27
LastLogon              :
Name                   : paul
SID                    : S-1-5-21-3297567932-2200011671-69726474-1001
PrincipalSource        : Local
ObjectClass            : Utilisateur"/>


### Cr√©ation d'un nouvel utilisateur

La commande `New-LocalUser` cr√©e un utilisateur local et retourne l'objet d√©crivant cet utilisateur dans le pipeline (comme il est d'usage par la majorit√© des commandes exploitant le verbe `New-`). Il faut √©videmment que la session PowerShell soit √©lev√©e en tant qu'admin pour apporter des modifications sur les utilisateurs locaux.

La commande offre un certains nombres de param√®tres pour sp√©cifier les diff√©rentes propri√©t√©s du compte √† cr√©er.

| Param√®tre | Type | Description |
| -- | -- | -- |
| `Name` | String | Le nom d'utilisateur (*login*) |
| `FullName` | String | Le nom complet (pr√©nom nom) |
| `Description` | String | Le champ Description |
| `AccountExpires` | DateTime | La date d'expiration de l'utilisateur |
| `AccountNeverExpires` | Switch | Indique que le compte n'expire jamais |
| `Disabled` | Switch | Indique que le compte est d√©sactiv√© d√®s sa cr√©ation |
| `Password` | SecureString | Le mot de passe de l'utilisateur |
| `NoPassword` | Switch | Indique que le compte n'a aucun mot de passe (pas tr√®s s√©curitaire!) |
| `PasswordNeverExpires` | Switch | Indique que le mot de passe n'expire jamais |
| `UserMayNotChangePassword` | Switch | Indique que l'utilisateur n'a pas le droit de modifier son mot de passe |
| `WhatIf` | Switch | Fait en sorte que la commande ne cr√©e pas l'utilisateur pour vrai (utile pour tester) |

:::info
Le mot de passe est de type `[SecureString]` et pas une cha√Æne de caract√®res normale. Ce qui fait qu'on doit d'abord convertir la cha√Æne de caract√®re en cha√Æne s√©curis√©e. On peut le faire au moyen de la commande `ConvertTo-SecureString`.

```powershell
$securepasswd = 'Passw0rd' | ConvertTo-SecureString -AsPlainText -Force
```
:::

Voici un exemple de cr√©ation d'un compte utilisateur local (en utilisant le *splatting*):

```powershell
$NouvelUtilisateurSplat = @{
    Name = "paul"
    FullName = "Paul Meilleur"
    Description = "Boss de la compagnie"
    AccountExpires = (Get-Date).AddDays(30)   # Dans 30 jours
    Password = ConvertTo-SecureString -String "Passw0rd" -AsPlainText -Force
}

New-LocalUser @NouvelUtilisateurSplat
```

:::danger
On ne devrait jamais mettre des mots de passe en clair dans un script, ni stocker un mot de passe dans une variable en texte clair!!! Voici quelques options pour l'√©viter:

- Cr√©er un algorithme qui choisit automatiquement un mot de passe en fonction d'information provenant de l'ext√©rieur
- Utiliser la commande `Read-Host -AsSecureString` pour demander √† l'utilisateur d'entrer un mot de passe (dont la saisie est masqu√©e
- Utiliser `Get-Credential` pour fournir un nom d'utilisateur et un mot de passe. Nous verrons plus loin cette commande lorsque nous traiterons de l'authentification par PowerShell.
:::

### Groupes locaux

√Ä l'instar des utilisateurs, on peut conna√Ætre les groupes locaux au moyen de la commande `Get-LocalGroup`.

Pour cr√©er un groupe local, on utilise la commande `New-LocalGroup`. L√† encore, cette commande ne fonctionne que dans une session PowerShell √©lev√©e.

Pour obtenir les membres d'un groupe, on peut utiliser la commande `Get-LocalGroupMember`.

<PowerShellWindow workdir="C:\" command="Get-LocalGroupMember -Group 'Administrateurs'" result="
ObjectClass Name                    PrincipalSource
----------- ----                    ---------------
Utilisateur PC0001\Administrateur   Local
Utilisateur PC0001\bob              Local
Utilisateur PC0001\paul             Local
Utilisateur PC0001\pierre           Local
Groupe      MINOU\Admins du domaine ActiveDirectory
Utilisateur MINOU\paul.meilleur     ActiveDirectory"/>

Pour ajouter un utilisateur dans un groupe, on utilise la commande `Add-LocalGroupMember`. Cette commande prend en param√®tre `-Member` qui d√©signe le membre √† ajouter, ainsi que `-Group` qui d√©signe le groupe dans lequel l'ajouter.

```powershell
Add-LocalGroupMember ‚ÄìMember "Paul" -Group "Administrateurs"
```

Cette commande admet qu'on passe le membre √† ajouter par le pipeline en entr√©e.

```powershell
Get-LocalUser -Name "Paul" | Add-LocalGroupMember -Group "Administrateurs"
```

Cela permet, entre autres, de cr√©er un compte et l'ajouter imm√©diatement √† un groupe, puisque la cr√©ation g√©n√®re un objet repr√©sentant l'utilisateur.

```powershell
New-LocalUser -Name "Zoe" -NoPassword | Add-LocalGroupMember -Group "Utilisateurs"
```

:::info
On peut aussi ajouter des utilisateurs ou des groupes du domaine comme membre d'un groupe local. Pour ce faire, on n'a qu'√† sp√©cifier le sAMAccountName du principal de s√©curit√© du domaine. Si la machine dispose d'une relation d'approbation avec le domaine du compte, celui-ci sera ajout√© comme membre au groupe.

```powershell
Add-LocalGroupMember ‚ÄìMember "DOMAINE\paul.meilleur" -Group "Administrateurs"
```
:::


:::tip
Le nom des groupes est diff√©rent sur les versions anglaise et fran√ßaise de Windows. Pour que le script fonctionne ind√©pendamment de la langue du syst√®me, on peut utiliser le SID du groupe plut√¥t que son nom. Le SID est un num√©ro d'identification unique, et dans le cas des groupes pr√©d√©finis dans Windows (Administrateurs, Utilisateurs), il est toujours le m√™me peu importe la langue.

On peut voir les SID des groupes avec la commande suivante:

```powershell
Get-LocalGroup | Select-Object -Property Name, SID
```

Voici quelques SID bien connus:

| Nom fran√ßais | Nom anglais | SID |
| -- | -- | -- |
| Administrateurs | Administrators | `S-1-5-32-544` |
| Utilisateurs | Users | `S-1-5-32 545` |

Par exemple, pour ajouter un utilisateur au groupe des administrateurs:

```powershell
$MonUtilisateur | Add-LocalGroupMember -SID "S-1-5-32-544"
```
:::



















## Gestion des comptes du domaine

### Outils RSAT

Lorsqu'on fait la promotion d'un serveur Windows en contr√¥leur de domaine, les outils d'administration d'Active Directory s'installent automatiquement sur cette machine. Les outils d'administration AD font partie d'une collection de consoles MMC connue sous le nom de RSAT (Remote Server Administration Tools).

Il existe plusieurs outils RSAT, qui sont normalement activ√©s lorsqu'on installe le r√¥le ou la fonctionnalit√© sur un serveur, afin d'√™tre utilis√©s localement sur ce serveur. Ce sont des composants optionnels de Windows, qui sont pr√™ts √† √™tre install√©s lorsque n√©cessaire. Ainsi, la console RSAT DNS est install√©e automatiquement sur un serveur lorsqu'on active le r√¥le DNS, et la console DHCP s'installe automatiquement sur un serveur DHCP, etc. On n'est pas oblig√© d'installer toutes les consoles RSAT, seulement celles dont on a besoin.

Lorsqu'on installe un r√¥le (par exemple, Active Directory Domain Services), les consoles pour AD s'installent automatiquement. Mais il arrive qu'on souhaite installer une console RSAT sur une machine pour l'administration √† distance. On peut donc installer les consoles ind√©pendamment, ce qui nous permet d'utiliser ce serveur pour administrer un service h√©berg√© sur un autre serveur.

Par exemple, il est rare que les administrateurs AD d√©marrent une session interactive RDP ou locale sur un contr√¥leur de domaine pour y cr√©er des utilisateurs. Ce n'est pas une bonne pratique. G√©n√©ralement, les administrateurs vont op√©rer la console sur une autre machine, soit leur poste de travail ou sur un serveur tiers qu'on qualifie de "jump station".

Les consoles qui font partie des outils RSAT pour Active Directory sont:

- Active Directory Users and Computers (dsa.msc)
- Active Directory Sites and Services (dssite.msc)
- Active Directory Domains and Trusts (domain.msc)
- ADSIEdit (adsiedit.msc)
- Active Directory Administrative Center (dsac.exe)
- Group Policy Managament Tool (gpmc.msc)

Lorsqu'on installe les outils RSAT pour Active Directory, un module PowerShell pour manipuler Active Directory s'installe √©galement. On peut utiliser ce module pour acc√©der √† des commandes PowerShell utilisable dans nos scripts pour automatiser ce que nous ferions normalement √† la main via les consoles MMC. Les outils RSAT install√©s sont expos√©s via l'√©l√©ment Administrative Tools du menu D√©marrer ou du vieux panneau de configuration de Windows (control.exe).

Les proc√©dures et les commandes pour installer les outils RSAT ne sont pas les m√™mes pour les √©ditions client et serveur de Windows.

#### Installer RSAT sous Windows Server

Sur un serveur Windows, par d√©faut, lorsqu'on installe un r√¥le ou une fonctionnalit√©, les outils RSAT correspondants s'installent aussi. Pour installer un outil RSAT sans installer le r√¥le ou la fonctionnalit√©, on peut utiliser les commandes dont le nom est *WindowsFeature*.

La commande `Get-WindowsFeature` permet d'obtenir la liste des r√¥les et fonctionnalit√©s (dans la m√™me liste, contrairement √† l'interface graphique). Chaque fonctionnalit√© a son nom qui respecte une convention de nommage, et toutes les consoles d'administrations commencent par le pr√©fixe RSAT (√† l'exception de la console de gestion des strat√©gies de groupe).

Pour voir tous les outils d'administration disponibles, on peut lancer:

```powershell
Get-WindowsFeature -Name "RSAT-*", "GPMC"
```

Pour installer toutes les consoles de gestion pour Active Directory DS, y compris la console de gestion des strat√©gies de groupe (GPMC) et le module PowerShell, lancez la commande suivante:

```powershell
Install-WindowsFeature -Name RSAT-AD-Tools, GPMC -IncludeAllSubFeature
```

#### Installer RSAT sous Windows 10/11

Sur un client Windows, les outils RSAT sont consid√©r√©s comme des composants optionnels, aussi appel√©s "Feature-on-Demand", qui peuvent √™tre install√©s √† la demande. Contrairement aux serveurs, les √©ditions clientes de Windows doivent t√©l√©charger les composants RSAT d'Internet sur les serveurs de mises √† jour de Microsoft.

Pour g√©rer ces composants optionnels, on peut utiliser les commande PowerShell dont le nom est "WindowsCapability".

Pour installer toutes les consoles de gestion pour Active Directory DS, y compris la console de gestion des strat√©gies de groupe (GPMC) et le module PowerShell, lancez la commande suivante:

```powershell
Get-WindowsCapability -Online | Where-Object -Match "^rsat\.activedirectory|grouppolicy.*$" | Add-WindowsCapability -Online
```

#### Module PowerShell pour ADDS

Les outils RSAT pour administrer Active Directory comprennent un module PowerShell qui offre une panoplie de commandes pour contr√¥ler AD.

Pour l'utiliser, il faut importer le module.

```powershell
Import-Module ActiveDirectory
```

:::info
Il n'est pas n√©cessaire d'ex√©cuter ces commandes √† partir d'un contr√¥leur de domaine. En fait, il est pr√©f√©rable de le faire √† partir d'un autre ordinateur, pourvu qu'il soit membre du domaine. C'est le compte utilis√© pour lancer les commandes qui importe, pas la machine sur laquelle elles sont lanc√©es.
:::

On peut ensuite lister toutes les commandes qui sont offertes par ce module.

```powershell
Get-Command -Module ActiveDirectory
```

On peut v√©rifier les modules install√©s qui sont disponibles pour √™tre import√©s. Pour v√©rifier quels modules sont import√©s dans la session PowerShell en cours, on utilise la commande `Get-Module`.

```powershell
Get-Module -ListAvailable
```

Pour charger le module Active Directory dans un script, on doit lancer la commande `Import-Module` au d√©but du script (plus pr√©cis√©ment, avant de lancer toute commande de ce module).

Il est aussi recommand√© d'ajouter une instruction `#Requires`, pour faire planter le script automatiquement avant m√™me le d√©but de son ex√©cution si le module Active Directory n'est pas install√©. On √©vite ainsi des erreurs plus tard dans le script.

```powershell
#Requires -Module ActiveDirectory
Import-Module ActiveDirectory
```

Plus de d√©tails sur l'instruction `#Requires` ici: https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_requires?view=powershell-5.1


### Informations sur le domaine et la for√™t

Les commandes `Get-ADDomain` et `Get-ADForest` permettent d'obtenir de l'information sur le domaine et la for√™t respectivement, tels que le niveau fonctionnel, les contr√¥leurs de domaine qui disposent d'un r√¥le FSMO, les conteneurs par d√©faut, le SID du domaine, la topologie des sites, etc.

[Get-ADDomain](./assets/r05/get-addomain.png)

Une information int√©ressante est celle du contexte de nom par d√©faut (*Default Naming Context*). Il √©quivaut √† la partie domaine √† la fin des noms distinctifs des objets dans le domaine. On peut l'obtenir √† l'aide de la commande `Get-RootDSE`.

```powershell
(Get-ADRootDSE).defaultNamingContext
```


### Unit√©s d'organisation

Les unit√©s d'organisation (*Organizational Unit*, ou *OU*) sont des conteneurs dans lesquels on peut disposer des objets du domaine et sur lesquels on peut lier des strat√©gies de groupe (GPO). Ce ne sont pas tous les conteneurs qui sont des unit√©s d'organisation; ces derni√®res portent le pr√©fixe `OU=` dans leur nom distinctif relatif.

![Unit√©s d'organisation](./assets/r05/ad-ou.png)


#### Recherche d'une unit√© d'organisation

Pour obtenir de l'information sur une unit√© d'organisation sp√©cifique, on peut utiliser la commande `Get-ADOrganizationalUnit` en lui fournissant le nom distinctif (DN) de l'unit√© d'organisation.

```powershell
Get-ADOrganizationalUnit -Identity "OU=Laptops,DC=ad,DC=mondomaine,DC=com"
```

On peut obtenir la liste de toutes les unit√©s d'organisation du domaine en sp√©cifiant le filtre *

```powershell
Get-ADOrganizationalUnit -Filter * | Format-Table
```

#### Cr√©ation d'une unit√© d'organisation

Pour cr√©er une unit√© d'organisation dans un domaine, on utilise la commande `New-ADOrganizationalUnit` en lui sp√©cifiant le nom de l'OU √† cr√©er ainsi que le nom distinctif complet du conteneur parent.

```powershell
$ADOrganizationalUnitSplat = @{
    Name = "Laptops"
    Path = "OU=Laptops,DC=ad,DC=mondomaine,DC=com"
}

New-ADOrganizationalUnit @ADOrganizationalUnitSplat
```

:::info
La commande `New-ADOrganizationalUnit` ne retourne pas d'objet par d√©faut dans le pipeline. Pour qu'elle en retourne un, on n'a qu'√† lui passer le switch `-PassThru`.

```powershell
New-ADOrganizationalUnit @ADOrganizationalUnitSplat -PassThru
```
:::


### Comptes utilisateurs

#### Recherche d'un compte utilisateur 

Pour rechercher un utilisateur dans Active Directory, la commande √† utiliser est `Get-ADUser`.

Pour rechercher un utilisateur sp√©cifique, on peut sp√©cifier le param√®tre `-Identity`. Ce param√®tre peut admettre comme valeur le nom d'utilisateur court (sAMAccountName), le nom distinctif (DN), le SID ou le GUID.

```powershell
Get-ADUser -Identity "zzappa"
```

Pour rechercher les utilisateurs ob√©issant √† certains crit√®res, on peut utiliser le param√®tre `-Filter`.

```powershell
Get-ADUser -Filter 'sAMAccountName -like "z*"'
```

#### V√©rification de l'existence d'un compte utilisateur

Pour tester l'existence d'un utilisateur dans le domaine, voici un exemple:

```powershell
if (Get-ADUser -Filter 'sAMAccountName -eq "zzappa"') {
    Write-Host "L'utilisateur existe."
}
else {
    Write-Host "L'utilisateur n'existe pas."
}
```


#### Cr√©ation d'un nouveau compte utilisateur

Pour cr√©er un nouvel utilisateur, on peut utiliser la commande `New-ADUser`. √âtant donn√© la quantit√© d'attributs disponibles dans les objets utilisateurs, cette commande admet un tr√®s grand nombre d'arguments. Voici un exemple de cr√©ation d'un compte utilisateur (la plupart de ces attributs sont facultatifs; en fait, seul le param√®tre `Name` est obligatoire).

```powershell
$ADUserSplat = @{
    Path = "OU=Utilisateurs,DC=ad,DC=mondomaine,DC=com"
    Name = "Zoe Zappa"
    GivenName = "Zo√©"
    Surname = "Zappa"
    Initials = "Z."
    Title = "Dr."
    DisplayName = "Dr. Zo√© Zappa, Ph.D."
    Description = "VP de ch√©poquoi"
    SamAccountName = "zzappa"
    UserPrincipalName = "zzappa@ad.mondomaine.com"
    AccountPassword = "Passw0rd" | ConvertTo-SecureString -AsPlainText -Force
    ChangePasswordAtLogon = $true
    StreetAddress = "42 rue des timinous"
    City = "Minoupolis"
    Country = "CA"
    PostalCode = "H0H 0H0"
    MobilePhone = "(555) 555-5555"
    EmployeeNumber = "2546011"
    EmailAddress = "zzappa@mondomaine.com"
    Enabled = $true
}

New-ADUser @ADUserSplat
```

#### Modification d'un compte utilisateur existant

On peut utiliser la commande `Set-ADUser` pour modifier un attribut d'un compte utilisateur existant. L'exemple suivant modifie l'adresse courriel de l'utilisateur Bob.

```powershell
$ADSetUserSplat = @{
    Identity = "Bob"
    EmailAddress = "bob@mondomaine.com"
}

Set-ADUser @ADSetUserSplat
```


#### Suppression d'un compte utilisateur

On peut utiliser la commande `Remove-ADUser` pour supprimer un compte utilisateur. Voici un exemple en lui passant un compte utilisateur par le pipeline.

```powershell
Get-ADUser -Identity "zzappa" | Remove-ADUser
```

:::tip
Dans son comportement par d√©faut, `Remove-ADUser` demande une confirmation. Pour rendre l'op√©ration compl√®tement automatique, on peut d√©sactiver le switch `-Confirm`, qui est activ√© par d√©faut (√©trangement).

```powershell
Remove-ADUser -Identity "zzappa" -Confirm:$false
```
:::


### Groupes

#### Recherche d'un groupe

Pour obtenir de l'information sur un groupe, on peut utiliser la commande `Get-ADGroup`. Cette commande s'emploie de la m√™me mani√®re que pour les utilisateurs.

```powershell
Get-ADGroup -Identity "Comptables"
```

Le param√®tre `-Identity` peut admettre le nom du compte (*sAMAccountName*) mais aussi son *SID*, son *GUID* ou son nom distinctif (*DN*).

```powershell
Get-ADGroup -Identity "CN=Comptables,OU=Groupes,DC=ad,DC=mondomaine,DC=com"
```

#### V√©rification de l'existence d'un groupe

Pour v√©rifier si un groupe existe, on peut employer la m√™me logique que pour les utilisateurs.

```powershell
if (Get-ADGroup -Filter 'sAMAccountName -eq "Comptables"') {
    Write-Host "L'utilisateur existe."
}
else {
    Write-Host "L'utilisateur n'existe pas."
}
```

#### Cr√©ation d'un nouveau groupe

Pour cr√©er un nouveau groupe, voici un exemple. Il faut minimalement sp√©cifier son nom, sa port√©e (global, domaine local ou universel) ainsi que le nom distinctif complet du conteneur dans lequel le cr√©er.

```powershell
$ADGroupSplat = @{
    Name = "Gestionnaires"
    GroupScope = "Global"
    Path = "OU=Groupes,DC=ad,DC=mondomaine,DC=com"
}

New-ADGroup @ADGroupSplat
```


### Membres de groupes

Un groupe poss√®de des membres, qui peuvent √™tre soit des utilisateurs, des ordinateurs ou d'autres groupes. On nomme ces objets des *principaux de s√©curit√©*. 

#### Obtention des membres d'un groupe

Pour consulter quels principaux de s√©curit√© sont membres d'un groupe sp√©cifique, voici un exemple:

```powershell
Get-ADGroupMember -Identity "Comptables"
```

On peut aussi passer un groupe par le pipeline.

```powershell
Get-ADGroup -Identity "Comptables" | Get-ADGroupMember
```

#### Ajout de membres √† un groupe

Pour ajouter un utilisateur √† un groupe, voici un exemple:

```powershell
Add-ADGroupMember -Identity "Admins du domaine" -Members "zzappa"
```

On peut √©galement ajouter un autre type de principal de s√©curit√©, comme un compte ordinateur ou un groupe. Le proc√©d√© est alors exactement le m√™me; il suffit de donner le nom du groupe ou de l'ordinateur dans l'argument `-Members`. Par ailleurs, puisque le param√®tre `-Members` admet un tableau, il est possible de lui passer un tableaux de membres, qui seront tous ajout√©s d'un coup au groupe.


#### Retrait de membres √† un groupe

Pour retirer un compte d'un groupe, il suffit d'utiliser cette commande:

```powershell
Remove-ADGroupMember -Identity "Admins du domaine" -Members "zzappa"
```

:::tip
Pour √©viter de d√©pendre de la langue du syst√®me et de la traduction de ses noms de groupes, on peut utiliser le SID des groupes bien connus, comme le groupe des admins du domaine.

Le SID du groupe des admins du domaine est constitu√© du SID du domaine suivi du RID 512. Ainsi, voici comment on peut le trouver dynamiquement.

```powershell
$DomainSID = (Get-ADDomain).DomainSID.Value
$DomainAdminSID = "$DomainSID-512"
Add-ADGroupMember -Identity $DomainAdminSID -Members "zzappa"
```
:::



### Attributs

Lorsqu'on utilise des commandes *Get* comme `Get-ADUser` ou `Get-ADComputer`, ce ne sont pas tous les attributs des objets qui sont interrog√©s, et ce, m√™me si on le passe dans un `Select-Object *`. Pour interroger un attribut qui ne l'est pas par d√©faut, il faut le sp√©cifier au moyen du param√®tre `-Properties`.

```powershell
Get-ADUser -Identity "zzappa" -Properties *
```

Par exemple, pour obtenir la date de cr√©ation, on peut ajouter la propri√©t√© `Created`, qui n'est pas incluse dans l'objet par d√©faut.

![Get-ADUser -Identity "zzappa" -Properties Created](./assets/r05/aduser-properties.png)






























### Outils suppl√©mentaires

Pour parcourir graphiquement les attributs des objets, on peut utiliser divers outils.


#### Fonctionnalit√©s avanc√©es de la console ADUC

Tout d'abord, la console Utilisateurs et ordinateurs Active Directory (*dsa.msc*) offre un onglet **√âditeur d'attributs**. Il n'est pas visible par d√©faut; il faut d'abord activer les **fonctionnalit√©s avanc√©es** de la console via le menu **Affichage**.

![ADUC Fonctionnalit√©s avanc√©es](./assets/r05/aduc-advanced.png) 

![ADUC √âditeur d'attributs](./assets/r05/aduc-attributeeditor.png)


#### ADSI Edit

Il existe √©galement un autre outil provenant des outils RSAT: l'outil de modification ADSI (adsiedit.msc). Il permet de parcourir la base de donn√©es LDAP du domaine et permet un meilleur contr√¥le du domaine, √† plus bas niveau. 

![ADSI Edit](./assets/r05/adsiedit-attributeeditor.png)


#### ADExplorer (Sysinternals)

Finalement, l'outil [ADExplorer](https://learn.microsoft.com/fr-ca/sysinternals/downloads/adexplorer), provenant de la suite [SysInternals](https://learn.microsoft.com/fr-ca/sysinternals) de Microsoft, permet de parcourir le domaine √† tr√®s bas niveau, tout comme ADSIEdit, mais ne n√©cessite pas l'installation des outils RSAT. Il permet une navigation plus fluide que ADSIEdit, en montrant l'arborescence LDAP dans le panneau de gauche et les attributs de l'objet s√©lectionn√© dans le panneau de droite. Cet outil n'est pas inclus dans Windows, il faut le [t√©l√©charger √† partir du site Web de Microsoft](https://learn.microsoft.com/fr-ca/sysinternals/downloads/adexplorer).

![ADSI Edit](./assets/r05/adexplorer.png)


#### Module AdsiPS

Le module Active Directory de Windows est tr√®s pratique mais pr√©sente deux inconv√©nients:
- Il n√©cessite l'installation des outils RSAT (donc des droits admin locaux et un acc√®s √† Microsoft Update)
- Ses commandes n'emploient pas le protocole LDAP standard (port 389/tcp) mais plut√¥t ADWS (port 9389/tcp)

Mon coll√®gue Fran√ßois-Xavier Cat a d√©velopp√© un module PowerShell qui se veut une alternative au module Active Directory. Il ne n√©cessite pas d'installation de RSAT et passe par le protocole LDAP.

Voici le lien vers son module: https://github.com/lazywinadmin/AdsiPS 

La mani√®re la plus simple d'installer le module est avec la commande Install-Module

```powershell
Install-Module -Name AdsiPS
```

Si vous ne disposez pas de droits d'administration sur votre machine, vous pouvez alors le faire seulement pour votre profil utilisateur

```powershell
Install-Module -Name AdsiPS -Scope CurrentUser
```

Consultez cette page pour conna√Ætre la syntaxe des commandes de ce module: https://github.com/lazywinadmin/AdsiPS/blob/master/docs/doc_functions.md 


## EXTRA: SID, RID et principaux de s√©curit√©

Dans les services de domaine Active Directory, certains objets ont la propri√©t√© de pouvoir se faire attribuer des droits √† des ressources. Ce sont ces types d'objets qui peuvent, par exemple, √™tre ajout√©s √† une liste de contr√¥le d'acc√®s (ACL). Ces objets se nomment les principaux de s√©curit√©. 

Active Directory compte quatre types de principaux de s√©curit√©: les comptes utilisateurs, les comptes d'ordinateurs, les groupes, ainsi que les comptes de service g√©r√©s, plus rarement utilis√©s. Ces objets poss√®dent un num√©ro unique de s√©curit√©, le SID, et c'est ce num√©ro qui est r√©f√©renc√© dans les listes de permissions.


### Principaux de s√©curit√© Active Directory

Certains utilisateurs et groupes dans un domaine Active Directory sont cr√©√©s automatiquement d√®s la cr√©ation du domaine. Leur nom peut varier d'un domaine √† l'autre, en fonction de la langue du premier contr√¥leur de domaine ayant √©t√© promu. Dans un domaine en anglais, le groupe des admins du domaine se nomme "Domain Admins", alors que dans un domaine en fran√ßais, il se nomme "Admins du domaine". M√™me chose pour le compte Administrateur, qui se nomme Administrateur en fran√ßais, et qu'il est m√™me possible de renommer au moyen d'une GPO. Cela peut compliquer le d√©veloppement de scripts, qu'on a avantage √† rendre le plus g√©n√©ral possible.

√Ä titre d'exemple, voici le SID du groupe des admins du domaine sur un domaine donn√©. Il est compos√© de l'identifiant du domaine, auquel on greffe un identifiant relatif, le RID, √† la fin de celui-ci. Le contr√¥leur de domaine qui d√©tient le r√¥le FSMO de RID Master est responsable de la gestion de ces RID, afin de s'assurer qu'ils sont uniques dans tout le domaine.

![SID et RID](./assets/r05/sid.png)

Les principaux de domaine, quant √† eux, sont relatifs au domaine, mais leur RID est toujours le m√™me d'un domaine √† l'autre. Le groupe des admins du domaine poss√®de le RID 512, donc leur SID est √©quivalent au SID du domaine, suivi de "-512". On peut donc obtenir le SID de tout principal de domaine simplement en connaissant son RID ainsi que le SID du domaine, qui peut √™tre obtenu par la commande Get-ADDomain. Les identifiants sont document√©s sur le site de Microsoft.

En voici quelques exemples:

| Nom                             | Type             | RID (d√©cimal) | RID (hexad√©cimal) |
| ------------------------------- | ---------------- | ------------- | ------------------|
| Administrateur                  | Utilisateur      | 500           | 0x000001F4        |
| Admins du domaine               | Groupe global    | 512           | 0x00000200        |
| Utilisateurs du domaine         | Groupe global    | 513           | 0x00000201        |
| Ordinateurs du domaine          | Groupe global    | 515           | 0x00000203        |
| Contr√¥leurs de domaine          | Groupe global    | 516           | 0x00000204        |
| Administrateurs du sch√©ma       | Groupe universel | 518           | 0x00000206        |
| Administrateurs de l'entreprise | Groupe universel | 519           | 0x00000207        |


Il est pr√©f√©rable d'utiliser le SID d'un de ces principaux, plut√¥t que son nom, car ainsi, le script peut fonctionner ind√©pendamment de la langue. Il suffit de r√©unir le SID du domaine et le RID du principal pour obtenir son SID.

```powershell
$DOMAIN_GROUP_RID_ADMINS = 512
$DomainSID = (Get-ADDomain).DomainSid.Value
$DomainAdminSID = "$DomainSID-$DOMAIN_GROUP_RID_ADMINS"
Get-ADGroup -Identity $DomainAdminSID
```

### Groupes de s√©curit√© locaux

Windows dispose de groupes cr√©√©s automatiquement d√®s son installation, ainsi que des principaux sp√©ciaux, comme les "utilisateurs authentifi√©s" ou le groupe "tout le monde". Ces principaux ont toujours le m√™me SID peu importe la machine et peu importe la langue. Les principaux locaux poss√®dent toujours le m√™me SID. 

| Nom                               | SID          |
| --------------------------------- | ------------ |
| Administrateurs                   | S-1-5-32-544 |
| Utilisateurs                      | S-1-5-32-545 |
| Utilisateurs du bureau √† distance | S-1-5-32-555 |
| Invit√©s                           | S-1-5-32-546 |
| Utilisateurs authentifi√©s         | S-1-5-11     |
| SYST√àME                           | S-1-5-18     |
| Tout le monde                     | S-1-1-0      |



R√©f√©rence: [Security identifiers (Windows 10) - Windows security | Microsoft Docs](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-identifiers)
